---
title: 渗透之windows之PE文件
date: 2020-09-22 09:55:30
tags:
	- 渗透

---

1

PE文件的全称是Portable Executable，意为可移植的可执行的文件，

常见的EXE、DLL、OCX、SYS、COM都是PE文件，

PE文件是微软Windows操作系统上的程序文件

它是1993年Windows NT系统引入的新可执行文件格式，到现在已经经过20多年了。

虽然使用PE作为可执行文件格式的Windows操作系统已经更换了很多版本，

其结构的变化、新特性的增加、文件格式的转换，以及内核的重新定位等，都发生了翻天覆地的变化，硬件架构也从16位发展到现在的64位架构，

**而这些变化对PE格式的影响却不大。**

由于**PE格式有较好的数据组织方式和数据管理算法**，面对如此多的变化却能保持其设计的优雅。



众所周知，Windows NT继承自VAX® VMS®和UNIX。

Windows NT的许多创建者在到Microsoft之前都曾为这些平台设计和编写程序。

**当他们设计Windows NT时，很自然会使用以前写过的和测试过的工具以尽快开始他们的新项目。**

这些工具产生的和使用的可执行文件和目标模块的格式被称为COFF（Common Object File Format的首字母，通用目标文件格式）。

**Microsoft编译器生成的OBJ文件就使用COFF格式。**



PE文件之所以被称为“可移植”是因为Windows NT在各种平台（x86、MIPS®、Alpha等等）上的所有实现都使用同样的可执行文件格式。

当然，像CPU指令的二进制编码之类的内容会有所不同。

重要的是操作系统加载器和编程工具不需要针对遇到的每种新的CPU再完全重写。

Windows NT及其以后版本，Windows 95及其以后版本和Windows CE一直到现在的win10都使用了这个相同的格式，

所以说在很大程度上，这个目的达到了。

对于64位的Windows，PE格式只是进行了很少的修改。

**这种新的格式被叫做PE32+。**

**没有加入新的域，只有一个域被去除。**

**剩下的改变只是一些域从32位扩展到了64位。**

在这种情况下，你能写出和32位与64位PE文件都能一起工作的代码。

**对于C++代码，Windows头文件的能力使这些改变很不明显。**

EXE和DLL文件之间的不同完全是语义上的。

它们都使用完全相同的PE格式。

**仅有的区别是用了一个单个的位来指出这个文件应该被作为EXE还是一个DLL。**

甚至DLL文件的扩展名也是不固定的，一些具有完全不同的扩展名的文件也是DLL，比如.OCX控件和控制面板程序（.CPL文件）。



PE文件格式主要来自于UNIX操作系统所通用的COFF规范，

**同时为了保证与旧版本MS-DOS及Windows操作系统的兼容，也保留了MS-DOS中那熟悉的MZ头部。**

PE格式被公开在WINNT.H头文件中（非常零散）。

在WINNT.H文件的中间有一个“Image Format”节。这个节以MS-DOS MZ格式和PE格式开头，后面才是新的PE格式。

WINNT.H提供了PE文件使用的原始数据结构的定义。



PE中涉及的地址有四类，他们分别是：

- 虚拟内存地址（VA）
- 相对虚拟地址（RVA）
- 文件偏移地址（FOA）
- 特殊地址



在PE中，进程本身的VA被解释为：进程的基地址 + 相对虚拟内存地址。

PE格式大量地使用所谓的RVA（相对虚拟地址）。

一个RVA，亦即一个“Relative Virtual Addresses（相对虚拟地址）”，是在你不知道基地址时，被用来描述一个内存地址的。

它是需要加上基地址才能获得线性地址的数值。

基地址就是PE映象文件被装入内存的地址，并且可能会随着一次又一次的调用而变化。



在一个可执行文件中，有许多在内存中的地址必须被指定的位置。

例如，当引用一个全局变量时就必须指定它的地址。

PE文件可以被加载到进程地址空间的任何位置。

虽然它们有一个首选加载地址，但你不能依赖于可执行文件真的会被加载到那个位置。

因为这个原因，指定一个地址而不依赖于可执行文件的加载位置就很重要。

为了消除PE文件中对内存地址的硬编码，于是产生了RVA。一个RVA是在内存中相对于PE文件被加载的地址的一个偏移。



因为PE-文件中的各部分（各节）不需要像已载入的映象文件那样对齐，事情变得复杂起来。

例如，文件中的各节常按照512（十六进制的0x200）字节边界对齐，而已载入的映象文件则可能按照4096（十六进制的0x1000）字节边界对齐。

参见下面的“SectionAlignment（节对齐）”和“FileAlignment（文件对齐）”。

因此，为了在PE文件中找到一个特定RVA地址的信息，你得按照文件已被载入时的那样来计算偏移量，但要按照文件的偏移量来跳过。

文件偏移地址（File Offset Address，FOA）和内存无关，他是指某个位置距离文件头的偏移。



在应用程序中最常出现的段有以下6种：

- 执行代码段，通常 .text （Microsoft）或 CODE（Borland）命名；
- 数据段，通常以 .data 
  、.rdata 或 .bss（Microsoft）、DATA（Borland）命名；
- 资源段，通常以 .rsrc命名；
- 导出表，通常以 .edata命名；
- 导入表，通常以 .idata命名；
- 调试信息段，通常以 .debug命名；

![](../images/random_name/20160429133720344)





参考资料

1、windows PE文件结构及其加载机制

https://blog.csdn.net/liuyez123/article/details/51281905