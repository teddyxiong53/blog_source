---
title: Linux之内核栈
date: 2020-07-17 13:29:51
tags:
	- Linux

---

--

一个用户态进程/线程在内核中都是用一个task_struct的实例描述的，

这个有点类似设计模式里面的桥接模式(handle-body), 

用户态看到的进程PID，线程TID都是handle, task_struct是body。

用户空间的堆栈，在task_struct->mm->vm_area里面描述，

都是属于进程虚拟地址空间的一个区域。

而内核态的栈在task_struct->stack里面描述，**其底部是thread_info对象**，

thread_info可以用来快速获取task_struct对象。**整个stack区域一般只有一个内存页(可配置)，32位机器也就是4KB。**

所以说，一个进程的内核栈，也是进程私有的，只是在task_struct->stack里面获取。



# Linux内核栈介绍

Linux 内核栈是操作系统内核用于执行内核代码的栈。每个任务（进程或线程）都有自己的内核栈，用于执行内核模式下的代码。下面是有关 Linux 内核栈的介绍：

1. **内核栈的作用**：
   - 内核栈用于执行内核模式下的代码，如中断处理程序、系统调用、任务切换等。它是操作系统内核的重要组成部分，负责处理任务上下文的切换和内核内部的各种操作。

2. **栈的隔离**：
   - 每个任务都有自己的内核栈，这确保了任务之间的隔离。如果一个任务的内核栈溢出或遇到问题，不会影响其他任务。

3. **内核模式和用户模式**：
   - 内核栈用于执行内核模式下的代码，而用户任务使用用户栈执行用户模式下的代码。内核栈和用户栈是分开的，从而保持了内核和用户空间的隔离。

4. **栈大小**：
   - 内核栈的大小通常较小，因为内核代码不应该占用太多栈空间。内核栈的大小在内核配置中定义，通常在 4KB 到 8KB 的范围内。

5. **栈溢出保护**：
   - 内核栈通常受到栈溢出保护的限制。如果内核栈溢出，可能会导致系统崩溃。因此，内核开发人员通常需要小心管理内核栈的使用，以避免栈溢出。

6. **中断处理**：
   - 内核栈在中断处理中起着重要作用。当发生中断或异常时，处理程序通常会在内核栈上运行，以便保存和恢复寄存器状态，处理中断，并在完成后返回用户模式。

7. **任务切换**：
   - 在进行任务切换时，当前任务的内核栈上的状态被保存，然后加载下一个任务的内核栈上的状态。这是任务切换的关键步骤之一。

8. **内核栈与用户栈的区别**：
   - 内核栈用于执行内核模式下的代码，通常包含内核函数的调用和中断处理。用户栈用于执行用户模式下的代码，包括用户进程的函数调用和用户空间栈操作。

总之，Linux 内核栈是内核的重要组成部分，用于执行内核模式下的代码，包括中断处理、系统调用和任务切换等。每个任务都有自己的内核栈，以保持任务之间的隔离。内核栈的大小通常较小，且受到栈溢出保护的限制，以确保系统的稳定性。

# 参考资料

1、怎么理解linux内核栈？

https://www.zhihu.com/question/57013926

