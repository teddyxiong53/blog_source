---
title: 普通家用路由器用的软件系统
date: 2017-09-01 23:08:59
tags:
	- 路由器

---



看家用路由器价格都很便宜，而且之前的路由器都没有标榜智能，我们知道现在的智能路由器一般是openwrt系统。那么之前那些不智能的路由器用的是什么系统呢？怎么做到那么稳定工作的呢？

主要是VxWorks和ecos这2个嵌入式os。

但是这个内存和flash都很小，在连接客户端多一些之后，就容易出问题了。

tplink就要主要用VxWorks的。

VxWorks支持几乎所有现代市场上的嵌入式 CPU，包括x86系列、MIPS、 PowerPC、Freescale ColdFire、Intel i960、SPARC、SH-4、ARM, StrongARM以及xScale CPU。



国内某厂买下了VxWorks的许可，向某国际大厂要到了SOC的所有技术信息，用VxWorks拿下了一片天地。为什么要用VxWorks呢？原 因很简单，这东东本身体积小，Flash的成本降下来了，运行的RAM成本降下来了。所以卖的价格也就降下来了。这个灰常特殊，因为只有一家国内某厂和一 家国际某大厂使用了这个模式。专事专用，完全封闭。



由于低价，所以eCos也就流行了起来，

除上面讲的某厂外，其它厂受不了低价的压力，向上游厂商寻求帮助，

所以某些SOC的供应商提供了eCos的 SDK。

注意：这里是原厂提供了SDK哟。

由于eCos的系统小，所以Flash和RAM的需求也就少了，**国内众多低价产品除了VxWorks就是 eCos为主了。**



一般情况下上述两个操作系统的无线路由器有几个特点：

- 减配严重，特别是内存和Flash
- 支持客户端很少，主要是内存太少了
- 客户端少时运行稳定，但是客户端多、流量大时就容易出问题
- 功能很少



由于Linux的功能丰富、开源特性，

在过去的某个年代里，所有的SoC都开始决定将自己的操作系统从落后的XX们转换成为LINUX，

这样就更高 大上而不显得哪么土鳖了。

也正是因为这样，2004年才使得OpenWRT出现了，这主要是因为Linux的开源协议。

即使都是Linux，也有两种不同 的情况原厂SDK和OpenWRT及其衍生发行版。



所以SoC生产厂就在 Linux基础上进行了很多的加工，加入各种驱动，为了硬件加速，改kernel的接口。

一切的一切都是为了让Linux能够支持这个SoC里的功能。

为 了让最终的路由器生产厂生产及加入自己的功能，原厂都为客户提供SDK，

这个SDK里就包括了一个基础的Linux和编译软件的环境。

由于厂商为了让系统 足够的稳定，**现在原厂SDK中的Linux都还在2.6.x的老旧年代。**

而且原厂的SDK要想得到，就需要和厂商签署保密协议和软件使用许可。

所以在互联 网上我们一般无法得到原厂SDK的软件。



OpenWRT是一个开源项目，它的出现就是为了让每个人都可以有一个开放的运行环境，

并且得到Linux里各种软件的支持。

所以 OpenWRT的Linux Kernel非常激进，但是正是因为它激进，所以在驱动上非常痛苦。

OpenWRT的驱动通常是开源社区的同学们写的驱动，或是从原厂SDK中的二进制移 植。

但是由于Kernel的过新，大量加速硬件的驱动都无法移植进来。

不过还是有众多的爱好者喜欢OpenWRT，原因很简单，它可以高度定制。



拿到固件后，将提出的固件用Binwalk分析，固件包含两部分CFE、ECOS系统；

CFE：A7A4，博通公司基于MIPS芯片的bootloader

ECOS：2001C，ecos操作系统模块，路由器核心代码也在其中



该路由的主板上未见到标明的UART接口。

这种情况可通过查找主芯片的DataSheet，找到对应的UART引脚，

或者测量端口电压方式（《揭秘家用路由器0day漏洞挖掘技术》一书中有详细介绍），

然后观察电路图，再飞线焊出接口。

这个板子所使用的芯片为BCM5357，通过搜索后未发现公开的DataSheet。

猜测主板标的几个TPN接口很可能就是它的调试接口，UART只需要三个接口，GND、TXD、RXD只要找正确GND和TXD就会有输出显示。

启动路由器，查看打印的引导信息，发现固件开始执行的地址为0×80001000。



参考资料

1、路由器操作系统盘点：VxWorks、eCos和OpenWRT

https://mobile.51cto.com/news-426607.htm

2、Tenda n301路由器固件分析

http://blog.topsec.com.cn/tenda-n301%E8%B7%AF%E7%94%B1%E5%99%A8%E5%9B%BA%E4%BB%B6%E5%88%86%E6%9E%90/