---
title: Linux内核之tickless无时钟
date: 2021-02-20 11:52:30
tags:
- Linux
---

--

Tick，即周期性产生的 timer 中断事件，

可用于系统时间管理、进程信息统计、低精度 timer 处理等等。

这样就会有一个问题，那就是在系统空闲的时候也还是周期性的产生中断，

系统会被周期性的唤醒导致功耗的增加，

这对于追求低功耗的嵌入式设备来说是很难接受的。

为此，内核开发者提出了**动态时钟的概念**，

即在系统**空闲阶段停掉周期性的时钟**达到节省功耗的目的。

内核可以通过配置项 CONFIG_NO_HZ 及 CONFIG_NO_HZ_IDLE 来打开该功能，

这样在系统空闲的时候就可以**停掉 tick 一段时间**，

但并不是完全没有 tick 了，当有除了 idle 进程之外的**其它进程运行的时候会恢复 tick** 。



clock_event_device，

代表一个可以产生时钟事件的硬件时钟设备，

**这样的时钟设备就像单片机的定时器，**

可以对它编程设置要触发的定时时间，

在定时时间到达的时候产生中断，它可以工作在周期模式或者单触发模式。

周期模式就是周期性的产生 timer 中断事件，这和 tick 的定义很像。



SMP 系统，

每个 CPU 都有一个只属于自己的 local timer 用于提供时钟事件服务，

在 CPU 启动的时候通过调用 percpu_timer_setup 函数完成初始化工作。

以三星 exynos7420 平台为例，

percpu_timer_setup 函数最终调用 exynos4_local_timer_setup 函数来初始化每个 CPU 的 local timer ，配置和注册 clock_event_device。



低分辨率定时器是基于 HZ 来实现的，

精度为 1/HZ，内核 HZ 一般配置为 100，那么低分辨率定时器的精度就是 10ms。

对定时器精度要求不高的内核模块还在大量使用低分辨率定时器，

例如 CPU DVFS，CPU Hotplug 等。

**内核通过 time_list 结构体来描述低分辨率定时器。**



高精度定时器可以提供纳秒级别的定时精度，

以满足对时间精度要求严格的内核模块，例如音频模块，

**内核通过 hrtimer 结构体来描述高精度定时器。**

在系统启动的开始阶段，

高精度定时器只能工作在低精度周期模式，

在条件满足之后的某个阶段就会切换到高精度单触发模式。

上面所说的 tick_periodic 函数，

最后会调用 hrtimer_run_pending 函数来判断是否可以切换到高精度模式。

另外，动态时钟也是在这里判断和切换的。流程如下：



tickless，即上面所说的动态时钟，之所以被称为 tickless，估计是为了更好的和 tick 联系起来。

另外，并不是真的没有 tick 了，只是在系统空闲的时候停掉 tick 一段时间。

使能了动态时钟之后，周期时钟的开关就由 idle 进程控制，

当满足条件时就可以停掉 tick 若干时间，这个流程如下：



停掉 tick 若干时间，那么这个若干时间是怎么得来的呢？

系统此时处于空闲状态只有 idle 进程在运行，还要处理可能产生的中断，

但是无法获知除了定时器中断以外的其它中断何时产生，

而定时器第一个即将到期的中断时间是可以得到的，

在这个时间到期之前都可以停掉 tick，由此得到需要停掉的 tick 数。

另外，停掉 tick 的时间不能超过 clock_event_device 的 max_delta_ns，

不然可能会造成 clocksource 的溢出。



参考资料

1、Linux Tick 和 Tickless

http://kernel.meizu.com/linux-tick-and-tickless.html