---
title: kmalloc分析
date: 2016-11-04 21:42:55
tags:
	- kmalloc
---
--

kmalloc的特点：

1. 速度快，不清零获取到的内存。
2. 获取的内存在物理上是连续的。
函数原型是：
```
#include <linux/slab.h>
void *kmalloc(size_t size, int flags);
```
下面我们重点看看flags这个参数。它用来控制kmalloc的行为。
* GFP_KERNEL。这个是最常用的一个标志。这个标志意味着当前进程在当前没有空闲内存的时候，会进入到睡眠状态来等待一会儿，让内核想办法来腾出一些内存来用。所以使用这个标志来kmalloc，不能在原子上下文里进行。
* GFP_ATOMIC。这个就跟GFT_KERNEL相对应，不会进入睡眠，暂时分不到就返回失败。一般用在中断里。
* GFP_USER。为用户空间页分配内存，可能睡眠。
* GFP_HIGHUSER。从高端内存分配。

# GFP_KERNEL

`GFP_KERNEL` 是 Linux 内核中用于内存分配的一种标志，它表示内核正在尝试在进程上下文中（即在进程执行期间）分配内存。这个标志通常用于表示对内存的普通请求，这些请求会尽可能快地满足，但在分配时可能会触发睡眠，因为如果没有可用的内存页，内核可能需要等待其他进程释放内存或者尝试清理一些内存页面。

`GFP_KERNEL` 的分配是适合大多数常规内存分配需求的。它意味着分配的内存可以用于进程的普通运行和处理，==不是针对实时性要求非常高的情况。它可能需要等待内存的释放或者执行一些内存回收机制来满足分配需求。==

在 Linux 内核编程中，开发者可以指定不同的 GFP 标志来满足不同的内存需求，例如 `GFP_ATOMIC` 用于在中断上下文中分配内存，`GFP_NOWAIT` 用于不触发睡眠的内存分配等。选择适当的标志对于内核性能和系统稳定性至关重要。