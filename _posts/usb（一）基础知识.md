---
title: usb（一）基础知识
date: 2018-04-05 09:20:02
tags:
	- usb

---



# 什么是usb

usb就是通用串行总线。

**它的出现主要是简化pc和外设的接口。**

usb是主从结构的，设备与设备之间、主机与主机之间不能相互连接。

为了解决这个问题，扩大usb的应用范围，又提出了usb OTG（On The Go）。**OTG可以同一个设备在不同场景，可以在主机和设备这2种身份之间切换。**



# usb的特点

## usb的速度

在usb1.0和usb1.1里面，只支持1.5Mbps的低速和12Mbps的全速模式。

在usb2.0里，加入了速度更快的480Mbps的高速模式。

usb3.0里，速度可以达到5Gbps。

## usb的优点

1、热插拔。

2、简单。

3、速度快。

4、标准统一。

5、价格便宜。

## usb的缺点

1、距离短。

2、开发调试难度大。



# usb的资源

https://www.usb.org

这个网站是公布usb协议和标准的官方网站。可以从这里下载协议文档。

现在的usb已经很流行了，就像以前的串口一样。



# usb的拓扑结构

usb是主从结构的，主机叫host，从机叫device。

有一类特殊的Device，叫usb hub，集线器，可以扩展host的usb口数量。

集线器只能扩展usb口的数量，带宽是不能扩展的。

通常，pc上有多个usb host controller和多个usb口。

每个controller下面有一个集线器。

例如，在我的电脑上，选择设备管理器，打开通用串行总线控制器。

```
英特尔（R）USB3.0根集线器
英特尔（R）USB3.0可扩展主机控制器
```

所有的数据传输，都是由host发起，device只是被动负责应答。

**usb OTG增加了一根线，叫做id标识线。用来表明它是host还是device。**



# usb的电气特性

标准的usb采用了4根线：

电源、地、D+、D- 。

**在低速和全速模式，是电压传输模式。**

**在高速模式下，是电流传输模式。**

usb使用的是NRZI编码。这种编码的特点就是bit为0，电平翻转，bit为1的时候，不翻转。

因为实际通信中，1比较多。这样就可以减少电平变化的次数，速度就容易上去。

usb协议规定，设备在未配置之前，可以从Vbus上最多获取100mA的电流，在配置之后，最多可以从Vbus上获取500mA的电流。

Vbus是5V的电压。

# usb的线缆和插头

usb协议规定，低速线的长度不能超过3m，高速线的长度不能超过5m。

还规定了线的颜色。

电源红色。地为黑色。D+为绿色。D-为白色。

不过有的没有遵循这个标准，注意点。



# usb的插入检测机制

这个要从集线器接收端的接口说起。

集线器接收端的D+和D-上，分别接了一个15K的下拉电阻。这样当接口没有插入设备时，对应的电平都是低电平。

而在usb设备端，在D+或者（注意是或者）D-上接了一个1.5K的上拉电阻到3.3V。

**具体是接到D+还是D-，是要看设备的速度的。**

**接到D+，是高速和全速设备。**

**接到D-，是低速设备。**

这样，当设备插入的时候，两个电阻分压，D+上的电压就是3V左右。

这个对于集线器来说，就是一个高电平信号。

然后把这个信号反馈给usb控制器。就检测到插入了。

usb高速设备先是被识别为全速设备，然后通过集线器和设备的确认，再切换为高速模式。

**高速模式下，是电流传输，这时候，会把D+上的上拉电阻断开。**

可以做这样一个简单的实验：

```
用一个10K的上拉电阻，接到usb的5V电压和D+之间，windows也会提示发现新硬件，但是无法找到驱动程序。
```



# usb的描述符

usb主机如何知道一个设备的信息呢？就是通过usb描述符。这个是usb协议里规定的。

usb1.1协议规定的标准描述符有：

1、设备描述符。

2、配置描述符。

3、接口描述符。

4、端点描述符。

5、字符串描述符。

我们为了降低入门难度，就以usb1.1的为例 。



# usb设备的枚举过程

usb主机在检测到设备插入后，就要对设备进行枚举了。

为什么要进行枚举？

**枚举就是读取设备的各种描述符。**这样主机就可以根据读取到的信息，加载对应的驱动程序，从而知道设备是什么设备，如何进行通信。

调试usb设备，很重要的一点，就是usb的枚举过程，枚举成功了，剩下的事情也就不多了。

在说枚举之前，我们先介绍一下usb的一种传输模式，控制传输。

控制传输在usb里是很重要的，它要保证数据的正确性。**在设备的枚举过程中，都是采用的控制传输。**

控制传输分为3个过程：

1、建立过程。

2、可选的数据过程。

3、可选的状态过程。

建立过程都是由usb主机发起，它开始于一个setup令牌包。后面紧跟着一个data0数据包。接着就是数据过程。

如果是控制读传输，那么数据过程就是输入数据。

如果是控制写传输，那么数据过程就是输出数据。

如果再建立过程中，指定了数据长度为0，那么就没有数据过程。

下面看看具体的过程：

1、usb检查到设备，对设备进行复位。

```
1）usb设备复位后的地址总是0，这样host就可以用地址0跟刚刚插入的设备进行通信。
```

2、host往地址为0的device的端点0发送获取设备描述符的请求。

3、设备收到请求后，在数据过程将设备描述符返回给主机。

4、主机收到设备描述符，就会返回一个0长度的确认数据包（状态过程）给设备。

5、现在进入设置地址阶段。主机向地址为0的端点0发出设置地址的请求（控制传输的建立过程），新的设备地址包含在数据包里了。具体的地址又主机负责管理。设备收到后，给主机反馈。

6、主机再次获取设备描述符。现在用的就是新的地址了。

7、主机获取配置描述符。配置描述符总共9个字节。

# usb包结构

usb通信是以包为单位的。

一个包被分为不同的域。

不同类型的包，里面的域是不同的。

但是，不同的包，也有共同之处，就是都要以同步域开始，紧接着是要给包id（简称pid），最后以包结束符来结束。

对于全速和低速设备，同步域是0x01 。

对于高速设备，同步域是0x0000 0001 。

pid是8bit。但是usb协议只用了低4位。另外4位是对低4位的取反。

## 包的分类

pid最多16种。0000被保留。

分为4大类：

1、令牌类。

2、数据类。

3、握手类。

4、特殊类。

# usb的四种传输类型

虽然usb定义了传输的基本单位是包。但是我们不能随意地使用包来传输数据。

必须把包组织成事务（transaction）才能传输数据。

什么是事务？

事务一般是由2个或者3个包组成。

```
令牌包、数据包、握手包。
```

usb协议规定了4种传输类型：

1、批量传输。

2、等时传输（也翻译为同步传输）

3、中断传输。

4、控制传输。

## 批量传输

批量传输是最容易理解，我们就从这里入手。

# usb的状态

USB的6种状态：接入态、电源态(供电态)、缺省态、地址态、配置态、挂起态。



USB协议涉及到的概念主要有：传输、事务、包、域，它们的关系又是怎么样的？

USB的传输主有四种：控制传输(目前工作用到)，同步传输，中断传输(目前工作用到)，批量传输。传输是USB中最大的单位，每种传输都有不同的事务来组成.

​     USB的事务主要有三种：输入事务(IN)、输出事务(OUT)、设置事务(SETUP)，每种事务又是由各种各样的包来组成。

USB的包(宏观上来说)有四种：令牌包、数据包、握手包、特殊包。包是USB传输数据的基本单位。每种类型的包都会有不同的域来构成。

USB的域是USB传输中最小的单位，域主要分为7类，分别是：同步域(SYNC)、标识域(PID)、地址域(ADDR)、端点域(ENDP)、帧起始域(SOF)、数据域(DATA)、CRC校验域(CRC)。





# 参考资料

1、《圈圈教你玩USB》第一章

2、浅谈总线通信机制----USB学习指南与总结

https://cloud.tencent.com/developer/article/1457016