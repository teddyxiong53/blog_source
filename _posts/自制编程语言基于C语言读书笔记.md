---
title: 自制编程语言基于C语言读书笔记
date: 2024-04-22 16:12:17
tags:
	- 语言

---

--

# 一些可能令人迷惑的问题

第一章讲了很多的理论知识。看不太懂也没有关系。

## 脚本语言的分类

基于命令的语言系统

基于规则的语言系统

面向过程的语言系统

面向对象的语言系统

## 什么是中间代码

中间代码称为IR（Intermediate Representation）

是介于code和机器语言之间的语言。

有这些：N元式（如三元式、四元式）、逆波兰、树等形式。

为什么要增加中间代码？

1、可以跨平台。

2、便于优化。

## 什么是编译器的前端、后端

```
source code -> 词法分析  -> 语法分析 ----> 生成IR  -> 优化代码  -> 生成目标代码
|<--------前端------------------->     |<------------后端-------------->|
```

词法分析把单词变成Token流。

这个就是编译器的6个步骤。

不过它们在实际编译器中并不是简单的串行，那样效率就太低了。

例如前面4步，就是以语法分析为主线，以并行穿插的方式执行。



# 设计一种面向对象的脚本语言

语言命名为sparrow，意思是麻雀，麻雀虽小五脏俱全。

支持的功能：

| 功能         | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| 变量         |                                                              |
| 基本数据类型 | 整数<br />字符串：包括普通字符和unicode<br />list：跟Python的list类似，支持字面量创建和new方法创建<br />map：跟Python的dict类似。<br />range： |
| 运算         | 数值：<br />逻辑：<br />位运算：<br />方法调用<br />索引<br />字符串 |
| 控制结构     | if else<br />while循环<br />for循环<br />break/continue<br />return |
| 函数         | 用fun定义函数。支持函数重载。                                |
| 类           |                                                              |
| 线程         | 支持线程的创建和调度                                         |
| 模块         |                                                              |
| 注释         | C语言方式的注释                                              |
|              |                                                              |

关键字

| 关键字   | 说明 |
| -------- | ---- |
| var      |      |
| fun      |      |
| if       |      |
| else     |      |
| true     |      |
| false    |      |
| while    |      |
| for      |      |
| break    |      |
| continue |      |
| return   |      |
| null     |      |
| class    |      |
| is       |      |
| static   |      |
| this     |      |
| super    |      |
| import   |      |

## 脚本的执行方式

使用传统的虚拟机作为执行方式。

也就是说要实现一个虚拟机。

编译器先把code编译为opcode，然后让虚拟机执行opcode。

# 实现词法分析器

词法分析器parser是编译器里最简单的部分。

## 柔性数组

就是为了让结构体维护的堆和结构体本身放在一起。

```c
struct sample {
	int len;
	char str[0];
};
char *str = "abcd";
int length = strlen(str);
struct sample *s = malloc(sizeof(struct sample) + length + 1);
```

柔性数组是gcc先做的，后面C99就接受了这种做法。



## c2/a

这个是表示chapter2的a目录。

这本书的配套代码提供的方式很方便阅读。

每章的代码是一个独立的目录。

可以通过不同目录对比来看出每个章节新增的内容。很方便阅读。

这个c2/a的内容就是定义了一个common.h、一个utils.c/h。

## c2/b

这个就增加了vm.h，实现了vm结构体。

## c2/c

这个在vm/目录下增加了core.c/h这2个文件。

提供了一个readFile的函数。

## c2/d

这个实现了utf-8的编解码。

## 实现parser

## c2/f

这个就开始实现cli.c。

# 类与对象

## 用C语言来实现类和对象

struct class来创建类。

struct ObjInstance来创建对象。但是不是所有的对象都需要这个。

为了跟踪所有的对象所属的类，所有对象都有一个通用的结构：对象头。

对象头里包含了对象类型和对象所属的类。

class也有它所属的类，meta类。

## 实现对象头c3/a

## 字节码

bytecode是语义分析的输出，是虚拟机的输入。

