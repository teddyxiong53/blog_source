---
title: Linux之文件锁
date: 2019-01-10 15:09:51
tags:
	- Linux
---



多个进程同时对一个文件进行读写操作的时候，就可能出现数据一致性的问题。

要保证安全，就需要进行加锁。

早期的unix系统，是对整个文件进行加锁的。

这样导致了一个比较严重的问题，就是无法运行数据库应用。

因为数据库要求记录级别的加锁机制，在System V Release3开始引入了fcntl来实现记录级的加锁。

这个后面成为posix标准的一部分。

Linux支持的锁技术包括：

1、劝告锁。

2、强制锁。

按照锁的特性，可以分为独占锁（写锁）和共享锁（读锁）。



劝告锁，类似信号量的保护机制，内核不强行干预。

需要大家共同遵守才有用。一般先查看一下，有没有锁，根据情况再进行操作。

如果某个进程完全不查看锁的情况，直接进行写入，也可以做到。

而强制锁，则是由内核干预的。

每当有open、read、write系统调用的时候，内核都会检查是否符合锁约束。

```
一个文件被加了共享锁，那么其他进程对这个文件的写入操作会被内核阻止。
一个文件被加了独占锁，其他进程对这个文件的读和写操作都会被内核阻止。
```



unlink不受强制锁影响。因为一个文件可能存在多个硬链接。删除硬链接不会影响文件的内容。



我看强制锁，用起来还比较麻烦，需要指定磁盘挂载的选项。

```
-o mand
```





参考资料

1、Linux 2.6 中的文件锁

https://www.ibm.com/developerworks/cn/linux/l-cn-filelock/index.html