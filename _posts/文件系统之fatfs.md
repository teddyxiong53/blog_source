---
title: 文件系统之fatfs
date: 2024-03-25 14:42:17
tags:
	- 文件系统

---

--

# fatfs简介

FatFS是一个轻量级的文件系统，专门设计用于嵌入式系统中。它由ChaN开发，其设计目标是在资源受限的嵌入式系统中提供可靠的文件系统支持。FatFS最初是为8位微控制器设计的，但也可以在其他类型的处理器上运行。

以下是FatFS的一些关键特点和功能：

1. **轻量级设计：** FatFS的设计非常紧凑，适用于内存和处理器资源受限的嵌入式系统。

2. **支持FAT文件系统：** FatFS支持FAT12、FAT16和FAT32文件系统，这些文件系统通常用于存储介质，如闪存卡和USB驱动器。

3. **可移植性：** FatFS的代码经过良好设计，易于移植到各种不同的硬件平台和操作系统中。

4. **易于集成：** FatFS提供了简单的API，使得开发人员能够轻松地在他们的嵌入式应用程序中集成文件系统功能。

5. **开源和免费：** FatFS是开源项目，可以免费使用，这使得它成为许多嵌入式系统开发人员的首选。

6. **可靠性：** FatFS经过广泛测试和验证，具有良好的稳定性和可靠性。它已被广泛用于许多嵌入式应用中。

总的来说，FatFS是一个在资源受限的嵌入式系统中提供可靠文件系统支持的理想选择，它的轻量级设计和易用性使得它成为许多嵌入式开发项目中的首选文件系统解决方案之一。

# 发展历史

FatFS的发展历史可以追溯到2000年代初。以下是FatFS的主要发展里程碑：

1. **2003年：** FatFS项目由ChaN创建。最初，FatFS是为使用FAT文件系统的8位微控制器设计的。

2. **2006年：** FatFS的第一个公开版本发布。该版本支持FAT12和FAT16文件系统。

3. **2008年：** FatFS发布了对FAT32文件系统的支持。这一更新使得FatFS能够处理更大容量的存储介质。

4. **2011年：** FatFS的源代码正式发布为开源项目，这使得开发人员可以自由地使用、修改和分发FatFS。

5. **2013年：** FatFS继续得到改进和更新，以提高其性能、稳定性和可靠性。此时，FatFS已经成为嵌入式系统中使用最广泛的文件系统之一。

6. **2016年：** FatFS的一个重要更新是添加了对长文件名（LFN）的支持。这一更新使得FatFS能够更好地处理长文件名，提高了用户友好性。

7. **至今：** FatFS仍然是一个活跃的开源项目，持续得到维护和更新。ChaN和其他贡献者不断改进FatFS，以适应新的硬件平台和应用场景，并提高其性能和功能。

总的来说，FatFS经历了多个版本迭代，不断发展壮大，成为嵌入式系统中广泛使用的文件系统解决方案之一。其简洁的设计、可靠的性能以及开源的特性，使得它成为许多嵌入式开发项目的首选文件系统库之一。

# fatfs代码说明

FatFS的源代码是相当庞大的，但是它的结构相对清晰，易于理解和使用。以下是对FatFS代码结构的简要说明：

1. **核心文件：**
   - **ff.c：** 这是FatFS的核心文件，包含了文件系统的实现。它包括了FAT文件系统的核心功能，例如文件的打开、关闭、读取、写入等。
   - **ff.h：** 这是FatFS的头文件，定义了各种数据结构、宏定义和函数声明，以便于其他文件引用FatFS的功能。

2. **配置文件：**
   - **ffconf.h：** 这个文件包含了FatFS的配置选项，例如定义了文件系统支持的最大卷数、最大文件数、缓冲区大小等参数。

3. **其他文件：**
   - **diskio.c 和 diskio.h：** 这些文件包含了与物理存储介质交互的接口函数。这些函数通常需要根据具体的硬件平台进行实现，以便FatFS能够与存储介质进行通信。
   - **integer.h：** 这个文件定义了平台无关的整数类型，确保FatFS可以在不同的平台上编译和运行。

4. **示例文件：**
   - FatFS还提供了一些示例文件，展示了如何在特定平台上使用FatFS。这些示例文件通常包括了初始化文件系统、打开/关闭文件、读取/写入文件等基本操作的示例代码。

5. **文档和注释：**
   - FatFS的代码中包含了详细的注释，解释了各个函数的作用和用法。此外，FatFS还提供了一份官方的文档，其中包括了对API函数的详细说明和示例用法。

总的来说，FatFS的代码结构相对清晰，易于理解。通过阅读核心文件（ff.c 和 ff.h），可以了解FatFS的主要实现原理和功能。配置文件（ffconf.h）允许用户根据具体需求对FatFS进行定制。其他文件则提供了与特定硬件平台交互的接口函数和示例代码。通过阅读官方文档和注释，可以更深入地了解FatFS的使用方法和技术细节。

# fatfs移植步骤

将FatFS移植到特定的嵌入式系统中需要按照以下步骤进行：

1. **了解目标平台：** 在进行移植之前，首先需要详细了解目标嵌入式系统的硬件和软件环境，包括处理器架构、存储介质类型、操作系统（如果有的话）、编译器和开发工具链等。

2. **获取FatFS源代码：** 从FatFS的官方网站或代码托管平台（如GitHub）获取最新的FatFS源代码。通常，FatFS的源代码以压缩包的形式提供，你需要将其解压缩到本地开发环境中。

3. **配置FatFS：** 根据目标系统的特性和需求，编辑FatFS的配置文件（ffconf.h）。这些配置选项包括文件系统支持的最大卷数、最大文件数、缓冲区大小等。

4. **实现磁盘I/O接口：** 根据目标系统的存储介质（如SD卡、NAND Flash等）以及文件系统的访问方式，实现磁盘I/O接口函数。这些函数负责与物理存储介质进行通信，包括初始化存储介质、读取扇区数据、写入扇区数据等操作。

5. **包含核心文件：** 将FatFS的核心文件（ff.c 和 ff.h）以及磁盘I/O接口文件（diskio.c 和 diskio.h）包含到你的项目中。

6. **调用FatFS API：** 在你的应用程序中使用FatFS提供的API函数来进行文件系统操作，包括文件的打开、关闭、读取、写入等操作。

7. **编译和调试：** 使用目标平台的编译器和开发工具链，编译你的应用程序，并在目标系统上进行调试和测试。确保FatFS能够正确地与目标系统集成，并且文件系统操作能够正常工作。

8. **优化和定制：** 根据需要对移植后的FatFS进行优化和定制，以适应特定的应用场景和硬件限制。

9. **文档和发布：** 编写适当的文档，说明如何在目标系统上使用移植后的FatFS，并将移植后的代码发布或集成到你的项目中。

通过按照以上步骤进行移植，你可以将FatFS成功地集成到目标嵌入式系统中，并实现文件系统的功能。

# 主要的api接口和结构体

FatFS 提供了一组 API 接口和结构体，用于在嵌入式系统中进行文件系统的操作。以下是一些主要的 API 接口和结构体：

### 主要 API 接口：

1. **`f_open()`：** 打开文件。
   
   ```c
   FRESULT f_open (
       FIL* fp,         // 指向 `FIL` 结构体的指针，用于保存打开文件的信息
       const TCHAR* path, // 文件路径
       BYTE mode         // 打开文件的模式
   );
   ```

2. **`f_close()`：** 关闭文件。

   ```c
   FRESULT f_close (
       FIL* fp // 指向 `FIL` 结构体的指针，表示要关闭的文件
   );
   ```

3. **`f_read()`：** 读取文件内容。

   ```c
   FRESULT f_read (
       FIL* fp,        // 指向 `FIL` 结构体的指针，表示要读取的文件
       void* buff,     // 用于存储读取数据的缓冲区
       UINT btr,       // 要读取的字节数
       UINT* br        // 实际读取的字节数
   );
   ```

4. **`f_write()`：** 写入文件内容。

   ```c
   FRESULT f_write (
       FIL* fp,        // 指向 `FIL` 结构体的指针，表示要写入的文件
       const void* buff, // 包含要写入的数据的缓冲区
       UINT btw,       // 要写入的字节数
       UINT* bw        // 实际写入的字节数
   );
   ```

5. **`f_opendir()`：** 打开目录。

   ```c
   FRESULT f_opendir (
       DIR* dp,        // 指向 `DIR` 结构体的指针，用于保存打开目录的信息
       const TCHAR* path // 目录路径
   );
   ```

6. **`f_readdir()`：** 读取目录项。

   ```c
   FRESULT f_readdir (
       DIR* dp,        // 指向 `DIR` 结构体的指针，表示要读取的目录
       FILINFO* fno    // 指向 `FILINFO` 结构体的指针，用于保存读取的目录项信息
   );
   ```

7. **`f_stat()`：** 获取文件或目录的信息。

   ```c
   FRESULT f_stat (
       const TCHAR* path, // 文件或目录的路径
       FILINFO* fno      // 指向 `FILINFO` 结构体的指针，用于保存文件或目录的信息
   );
   ```

### 主要结构体：

1. **`FIL`：** 文件对象结构体，表示打开的文件。

   ```c
   typedef struct {
       BYTE flag;          // 文件状态标志
       BYTE err;           // 最后的错误代码
       FRESULT fptr;       // 文件当前读/写指针的位置
       DWORD fsize;        // 文件大小（字节数）
       DWORD fptr;         // 文件当前读/写指针的位置
       DWORD clust;        // 文件所在的簇号
       DWORD sect;         // 文件所在扇区
       UINT* buf;          // 数据缓冲区
   } FIL;
   ```

2. **`DIR`：** 目录对象结构体，表示打开的目录。

   ```c
   typedef struct {
       WORD id;            // 目录对象的 ID
       WORD index;         // 当前目录项的索引
       DWORD sclust;       // 起始簇号
       DWORD clust;        // 当前簇号
       DWORD sect;         // 当前扇区号
       BYTE* dir;          // 目录项数据缓冲区
       BYTE* fn;           // 文件名指针
   } DIR;
   ```

3. **`FILINFO`：** 文件信息结构体，用于保存文件或目录的信息。

   ```c
   typedef struct {
       DWORD fsize;        // 文件大小（字节数）
       WORD fdate;         // 文件日期
       WORD ftime;         // 文件时间
       BYTE fattrib;       // 文件属性
       TCHAR fname[13];    // 文件名
   } FILINFO;
   ```

这些 API 接口和结构体提供了基本的文件系统操作功能，开发人员可以使用它们在嵌入式系统中实现文件的读写、目录的浏览等功能。

# 用fatfs实现一个mp3播放器

使用 FatFS 实现一个简单的 MP3 播放器可以分为以下步骤：

1. **准备硬件：** 首先，你需要一个支持储存介质的嵌入式系统，比如基于 ARM Cortex-M 的开发板，并连接一个 SD 卡模块用于存储 MP3 文件。另外，你还需要一个音频解码器芯片（比如 VS1053），用于解码 MP3 文件并输出音频信号。

2. **初始化硬件：** 编写初始化代码，初始化 SD 卡模块、音频解码器等外设，并配置相应的引脚、时钟和通信接口。

3. **集成 FatFS：** 将 FatFS 移植到你的嵌入式系统中，并实现磁盘 I/O 接口函数，以便 FatFS 能够读取 SD 卡上的文件。

4. **解析 MP3 文件：** 编写代码来解析 MP3 文件，读取其中的音频数据并将其传输给音频解码器。

5. **音频解码和播放：** 使用音频解码器芯片解码 MP3 文件的音频数据，并将解码后的音频信号输出到音频设备（如扬声器）上，从而实现音乐播放功能。

6. **用户界面：** 如果需要，可以添加一个用户界面，比如 LCD 屏幕和按键，用于选择和控制播放的 MP3 文件。

7. **调试和测试：** 完成代码编写后，进行调试和测试，确保 MP3 播放器能够正常工作，并能够播放 SD 卡上的 MP3 文件。

8. **优化和扩展：** 对代码进行优化，提高系统的性能和稳定性。根据需要，你还可以扩展 MP3 播放器的功能，比如添加播放列表、音量控制、播放模式等功能。

请注意，上述步骤仅为概述，并不能详尽涵盖所有细节。实际开发过程中可能会遇到各种挑战和问题，需要根据具体情况进行调整和解决。此外，使用 FatFS 实现 MP3 播放器可能会涉及到一定的计算和存储资源，需要确保嵌入式系统具有足够的性能和内存空间。

# CH32 RISC-V内核上移植FatFs文件系统



https://cloud.baidu.com/article/3247377



# 文档

https://shatang.github.io/2020/09/22/FatFs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/

# 官网

http://elm-chan.org/fsw/ff/00index_e.html

官网文档很系统严谨。

