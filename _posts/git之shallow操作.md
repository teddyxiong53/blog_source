---
title: git之shallow操作
date: 2022-08-09 10:55:08
tags:
	- git

---

--

shallow操作，可以叫浅克隆。

但是浅克隆版本库也存在着很多限制，如：

- 不能从浅克隆版本库克隆出新的版本库。
- 其他版本库不能从浅克隆获取提交。
- 其他版本库不能推送提交到浅克隆版本库。
- 不要从浅克隆版本库推送提交至其他版本库，除非确认推送的目标版本库包含浅克隆版本库中缺失的全部历史提交，否则会造成目标版本库包含不完整的提交历史导致版本库无法操作。
- 在浅克隆版本库中执行合并操作时，如果所合并的提交出现在浅克隆历史中，则可以顺利合并，否则会出现大量的冲突，就好像和无关的历史进行合并一样。

由于浅克隆包含上述限制，因此浅克隆一般用于对远程版本库的查看和研究，如果在浅克隆版本库中进行了提交，最好通过**git format-patch**命令导出为补丁文件再应用到远程版本库中。



下面的操作使用**git clone**命令创建一个浅克隆。注意：源版本库如果是本地版本库要使用`file://`协议，若直接接使用本地路径则不会实现浅克隆。

```
$ git clone --depth 2 file:///path/to/repos/hello-world.git shallow1
```



对于正常的Git版本库来说，如果对象库中一个提交丢失绝对是大问题，版本库不可能被正常使用。而浅克隆之所以看起来一切正常，是因为Git使用了类似嫁接（下一节即将介绍）的技术。

在浅克隆版本库中存在一个文件`.git/shallow`，这个文件中罗列了应该被视为提交根节点的提交SHA1哈希值。查看这个文件会看到提交`d81896e`正在其中：

```
$ cat .git/shallow
b56bb510a947651e4717b356587945151ac32166
d81896e60673771ef1873b27a33f52df75f70515
e64f3a216d346669b85807ffcfb23a21f9c5c187
```

列在`.git/shallow`文件中的提交会构建出对应的嫁接提交，使用类似嫁接文件`.git/info/grafts`（下节讨论）的机制，当Git访问这些对象时就好像这些对象是没有父提交的根节点一样。



我当前的问题解决。

在buildroot/.git（这个目录实际是软链接到.repo/projects/buildroot.git目录的）里加shallow文件，把上面3个sha值放进去。

然后把buildroot目录删掉，重新同步buildroot就正常。查看日志也可以正常查看到2001年的。不会报错误。



# 参考资料

1、

https://www.worldhello.net/gotgit/08-git-misc/090-sparse-checkout-and-shallow-clone.html