---
title: Linux之sysfs了解
date: 2018-01-28 18:52:43
tags:
	- Linux
	- sysfs

---

--

# 一些认识

/sys/class，这个目录，相当于windows的设备管理器。可以看到各类设备的具体信息。

或者说，/sys目录下的目录，是从不同的维度来观察设备的构成。



sysfs的作用是什么？

1、建立系统里bus、driver、device这三者之间的桥梁。

2、在用户空间展示内核里各种device的拓扑图。

3、对用户空间暴露接口，取代部分ioctl功能。



sysfs跟proc类似，都是提供了一种从shell访问内核数据的方式。但是sysfs会比proc更好一些。其中最重要的一点就是设计上更加清晰。

proc里的文件格式各不相同，用户程序读取后，可能要进行字符串解析，才能取得有效信息。

**而sysfs的设计原则是：一个属性文件只做一件事情。里面只有一个值。**



对于驱动开发者，如果想要把驱动跟用户程序建立连接，可以选择的方法有：

**1、注册cdev设备。ioctl来设置属性。但是无法在脚本里用。**

2、注册proc。

3、注册sysfs。



不过一般是这3个都做的。proc可以选择不做了。

sysfs需要增加的代码最少。可维护性也最好。



**一般最少是需要cdev设备的。其他两个是补充性的。**



/dev节点的缺点：

1、一般用read/write/ioctl来进行操作。

2、read/write，只能做一件事。

**3、ioctl可以实现多种功能。但是无法在shell脚本里使用。还有大小端不兼容、64位兼容问题。**



/proc的缺点：

1、写代码比较麻烦。



/sys节点的优点：

1、在用户层都是可见的，透明的。

2、需要增加的代码是最少的。



一个比喻：

sysfs提供对包装的访问，而dev提供对盒子里的东西的访问。



/dev 独立于 /sys 存在的部分原因是历史性的：

/dev 可以追溯到 Unix 诞生之初，

而 /sys 是一个更近的发明。

如果 Linux 是在没有历史背景的情况下设计的，

那么 /dev/sda 可能是 /sys/block/sda/content。





# /sys/devices 目录下的内容介绍

在Linux系统中，`/sys/devices`目录是一个虚拟文件系统，提供了对系统中所有设备的信息和控制的接口。该目录下包含了系统中各种设备的设备树结构，并通过文件和目录的形式向用户和应用程序提供设备相关的信息。

`/sys/devices`目录下的内容可以根据设备的类型和连接方式进行组织。以下是一些常见的子目录和文件：

- `system`: 系统设备目录，包含了一些系统级设备的信息，如系统时钟、定时器等。
- `platform`: 平台设备目录，包含了与硬件平台相关的设备信息，如主板上的各种集成设备和总线控制器。
- `cpu`: CPU设备目录，包含了与CPU相关的信息，如处理器的拓扑结构、频率调节等。
- `pci`: PCI设备目录，包含了通过PCI总线连接的设备的信息。
- `usb`: USB设备目录，包含了通过USB总线连接的设备的信息。
- `block`: 块设备目录，包含了磁盘、分区等块设备的信息。
- `input`: 输入设备目录，包含了键盘、鼠标等输入设备的信息。
- `net`: 网络设备目录，包含了网络接口和网络设备的信息。
- `tty`: 终端设备目录，包含了串口设备的信息。
- `power_supply`: 电源设备目录，包含了电源供应器的信息。
- `drm`: 显卡设备目录，包含了图形显示设备的信息。

每个设备目录下可能包含多个子目录和文件，用于提供设备的属性、状态、配置等信息。这些文件通常以`uevent`、`modalias`、`dev`、`subsystem`等命名。

通过访问`/sys/devices`目录及其子目录，可以获取系统中各种设备的信息，并对其进行配置和管理。这对于识别和调试设备、了解设备状态以及进行设备驱动程序开发非常有用。

请注意，具体的文件和目录结构可能会因系统配置、硬件和内核版本而有所不同。上述内容仅提供了一般情况下的介绍，具体细节可能会有所差异。建议查阅系统文档或内核文档以获取更准确和详细的信息。

# /sys/devices/virtual介绍

在Linux系统中，`/sys/devices/virtual`目录是一个虚拟设备目录，用于表示虚拟设备和虚拟文件系统的设备。这些设备并非真实的物理设备，而是由内核创建的用于提供特定功能或接口的虚拟设备。

`/sys/devices/virtual`目录下包含了多个子目录，每个子目录代表一个虚拟设备或虚拟文件系统。以下是一些常见的子目录和其对应的功能：

- `vc`: 虚拟终端设备目录，提供了虚拟控制台终端的接口。
- `console`: 控制台设备目录，提供了对控制台设备的配置和控制。
- `input`: 虚拟输入设备目录，提供了模拟输入设备的接口，如虚拟键盘、鼠标等。
- `fs`: 虚拟文件系统设备目录，用于创建和管理虚拟文件系统。
- `powercap`: 虚拟功耗管理设备目录，提供了对功耗管理的接口。
- `snd`: 虚拟音频设备目录，提供了虚拟声卡设备的接口。
- `usbmon`: USB监视设备目录，提供了对USB设备通信的监视和记录。
- `firmware`: 虚拟固件设备目录，提供了访问固件接口的功能。

这些虚拟设备或虚拟文件系统的目录中可能包含了各种属性文件、控制文件和状态文件，用于配置和控制相应的功能。通过访问`/sys/devices/virtual`目录及其子目录，可以获取虚拟设备的信息和管理接口。

需要注意的是，具体的子目录和设备结构可能因系统配置、内核版本和安装的软件包而有所差异。上述内容仅提供了一般情况下的介绍，具体细节可能会有所不同。建议查阅系统文档或内核文档以获取更准确和详细的信息。

# 参考资料

1、

https://www.ibm.com/developerworks/cn/linux/l-cn-sysfs/index.html

2、内核Uevent事件机制 与 Input子系统

https://www.cnblogs.com/sky-heaven/p/6394267.html

3、

https://unix.stackexchange.com/questions/176215/difference-between-dev-and-sys