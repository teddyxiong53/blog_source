---
title: Linux内核之timer使用
date: 2022-04-24 15:58:01
tags:

	- Linux内核

---

--

```
结构体
struct timer_list
使用接口：
add_timer
mod_timer
del_timer

```

低分辨率定时器是基于HZ来实现的，

也就是说，每个tick周期，都有可能有定时器到期，

系统中有可能有成百上千个定时器，

难道在每个tick中断中遍历一下所有的定时器，检查它们是否到期？

内核当然不会使用这么笨的办法，

它使用了一个更聪明的办法：

按定时器的到期时间对定时器进行分组。

因为目前的多核处理器使用越来越广泛，

连智能手机的处理器动不动就是4核心，

内核对多核处理器有较好的支持，

低分辨率定时器在实现时也充分地考虑了多核处理器的支持和优化。

为了较好地利用cache line，也为了避免cpu之间的互锁，

内核为多核处理器中的每个cpu单独分配了管理定时器的相关数据结构和资源，

**每个cpu独立地管理属于自己的定时器。**

# Linux内核的tickless怎么工作的？那么定时器还能用吗？

"Tickless"内核是指一种Linux内核配置，

它允许系统在没有周期性的"时钟滴答"（tick）中断的情况下运行，

从而在系统处于空闲状态时降低功耗，提高效率。

传统的Linux内核使用固定的时间间隔来触发时钟中断，即使没有任务需要执行。

"Tickless"内核根据需要触发中断，以便在实际需要时执行任务，这称为"节拍自由"。

Tickless内核的工作方式如下：

1. **系统空闲检测**：Tickless内核会检测系统是否处于空闲状态，即没有任务需要执行。这通常是通过检查运行队列中是否有可运行的任务来确定的。

2. **定时器调度**：如果系统被认为处于空闲状态，Tickless内核会计算下一个需要执行的任务的时间戳，然后设置一个定时器以在那个时间点触发中断。

3. **中断触发**：当设置的时间点到达时，系统会触发中断，内核将执行所需的任务。这通常包括计划的任务，如任务调度、定时事件和可能的电源管理操作。

4. **返回空闲检测**：在任务完成后，内核重新检测系统是否仍处于空闲状态，并根据需要设置下一个定时器。

Tickless内核的好处包括降低系统的功耗，减少中断的频率，提高系统的响应速度，尤其是在多核系统上。这使得Linux可以更好地适应嵌入式设备、移动设备和服务器等各种场景。

定时器仍然可以在Tickless内核中使用，但它们的工作方式可能有所改变。

定时器通常与系统时钟有关，它们可以用于执行周期性任务或在将来的某个时间点触发事件。

在Tickless内核中，定时器可能会更智能地管理，以充分利用节拍自由的优势。

总之，Tickless内核允许Linux系统更灵活地管理系统的定时和中断，以提高效率和降低功耗。定时器仍然是有用的，但它们的工作方式可能会更适应Tickless内核的特性。这些改进使Linux系统在各种应用中更加灵活和高效。

# 参考资料

1、

https://blog.csdn.net/wll1228/article/details/107546023