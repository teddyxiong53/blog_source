---
title: 500lines之ci
date: 2019-10-23 10:43:49
tags:
	- 500lines

---

1

ci是持续集成。

这个项目用python实现了一个小的ci系统。

在软件开发的过程中，我们需要确认我们的改动都是安全的，这就需要运行测试用例。

当代码量不那么大的时候，我们可以手动运行测试用例。

当代码量大了后，我们希望把这个过程自动化。

ci系统就是用来做这个自动化的。

一旦检测到新的提交，ci系统就会运行，确保这个提交后，所有用例可以运行通过。

为了达到这个目的，ci系统应该可以fetch新的修改，运行测试，报告结果。

而且应该在出错的时候，可以继续把后面的用例执行完。



本项目使用了git作为版本管理工具。

只运行项目下面tests目录下的代码。

为了简化问题，我们使用本地仓库。

你可以配置系统每次提交都进行测试，也可以累计几次提交再测试。

我们当前采用每5s检测一下的方式。这个时间可以调节，如果比较长，你在期间可能进行了多次提交，也是做一次测试。

github提供了一个“post-commit hooks”的接口。会给你配置的某个url发送通知。

我们也对本地仓库实现一个类似的功能。



一个ci系统由三部分组成：

1、观察者。

2、test job 分发器。简称分发器。

3、test runner。简称运行器。

观察者观察repo，发现提交后，通知分发器，分发器找到一个运行器来运行。

为了提高容错性和负载能力，上面3个组件，是3个独立的进程。

每个进程可以有多个单独的实例。

进程之间通过socket进行通信。

这样方便我们把进程部署到不同的机器上。



观察者：repo_observer.py。

分发器：dispatcher.py。监听8888端口。

运行器：test_runner.py。监听8900端口。



通信都是一次性的tcp，用完就关闭。

发送的消息就是字符串，例如发送“ping”，回复“pong”。



参考资料

1、对应代码目录下的readme文件

