---
title: java之jni
date: 2020-09-17 14:12:13
tags:
	- java
---

1

HelloWorld.java

```
public class HelloWorld {
    public native void displayHelloWorld();
    static {
        System.loadLibrary("hello");
    }
    public static void main(String[] args) {
        new HelloWorld().displayHelloWorld();
    }
}
```

生成class文件。

```
javac HelloWorld.java
```

生成jni头文件。

```
javah HelloWorld
```

得到的HelloWorld.h如下：

```
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class HelloWorld */

#ifndef _Included_HelloWorld
#define _Included_HelloWorld
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     HelloWorld
 * Method:    displayHelloWorld
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_HelloWorld_displayHelloWorld
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```

然后编写对应的实现。

新建HelloWorldImpl.c。

```
#include "jni.h"
#include "HelloWorld.h"
 
//#include otherheaders
 
JNIEXPORT void JNICALL
Java_HelloWorld_displayHelloWorld(JNIEnv *env, jobject obj)
{
    printf("Hello jni!\n");
    return;
}
```

编译得到dll文件。

```
gcc -Wall -D __int64="long long" -D_JNI_IMPLEMENTATION_ -Wl,--kill-at -ID:\android_studio\jre\include -ID:\android_studio\jre\include\win32 -shared  HelloWorldImpl.c -o hello.dll
```

运行会崩溃。因为当前的工具链有点乱。

我在Linux下来做。

/usr/lib/jvm/java-8-openjdk-amd64/include/jni.h

编译so

```
gcc -Wall  -D_JNI_IMPLEMENTATION_ -I/usr/lib/jvm/java-8-openjdk-amd64/include -I/usr/lib/jvm/java-8-openjdk-amd64/include/linux -shared -fPIC  HelloWorldImpl.c -o hello.so
```

这样运行是找不到的。

改成libhello.so看看。

无论直接改文件名字，还是改命令重新编译。还是不行。

可以改一下java里的load里面为完整路径的。

```
static {
        System.loadLibrary("/home/hlxiong/work/test/java/libhello.so");
    }
```

但是现在不行。提示这个。

```
Directory separator should not appear in library name
```

```
gcc -Wall  -D_JNI_IMPLEMENTATION_ -I/usr/lib/jvm/java-8-openjdk-amd64/include -I/usr/lib/jvm/java-8-openjdk-amd64/include/linux -shared -fPIC  HelloWorldImpl.c -o libHelloWorld.so
```

这样执行：

```
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$PWD; export CLASSPATH=$CLASSPATH:$PWD; java HelloWorld
```



```
export JAVA_INC=/usr/lib/jvm/java-8-openjdk-amd64/include

# step 1: compile the .class file with invocation to a native method
javac HelloJNI.java
# step 2: auto-generate a .h header file from said Java source
javah HelloJNI

# step 3: make the shared library with the name linked in said Java source, and implementing said native method
g++ -std=c++11 -shared -fPIC -I$JAVA_INC -I$JAVA_INC/linux HelloJNIImpl.cpp -o libhello.so

# step 4: run JVM with java.library.path set to include said shared library
java -Djava.library.path=. HelloJNI
```



参考资料

1、JNI

https://baike.baidu.com/item/JNI/9412164?fr=aladdin

2、

https://blog.csdn.net/huachao1001/article/details/53906237

3、

https://blog.csdn.net/qq_28885149/article/details/77452622

4、

这个讲清楚了。

https://www.cnblogs.com/hibraincol/archive/2011/05/14/2046049.html

5、

这里放了代码片段，直接下载zip文件就可以运行。

https://gist.github.com/santa4nt/4a8fd626335e36c94356