---
title: 编程之链接脚本学习
date: 2018-12-06 14:55:28
tags:
	- 编程
---



之前对于链接脚本，使用并不多。

现在用炬芯的方案做东西，他们的就是大量使用了链接脚本。所以我需要对链接脚本进行深入学习。



链接脚本的主要用途：

1、描述输入文件的里的section如何被映射到输出文件里。

2、控制输出文件的内存排布。

链接脚本就干了这两件事。



我们在Linux下应用程序的时候，一般不自己写链接脚本，这时候gcc默认给我们提供了一个默认的链接脚本。

可以使用-T选项来指定自己的链接脚本。



# 链接脚本的格式

链接脚本是文本文件。

注释风格跟C语言一样。



# 简单的链接脚本

最简单的脚本只需要一个命令SECTIONS。

下面是一个最简单的脚本。

```
SECTIONS 
{
	. = 0x10000;
	.text : { *(.text) }
	. = 0x80000000;
	.data : { *(.data) }
	.bss: { *(.bss) }
}
```

在这个脚本里，我们把代码端指定懂啊0x10000的位置，数据段放在0x80000000这里。

`.`这个是定位计数器。

## MEMORY命令

链接器在缺省状态下，是可以分配所有地址空间内的内存块的。

对于很多嵌入式芯片，内存空间是不连续的，所以就需要用MEMORY命令来指定。

一个链接脚本里最多只能用一次。

语法是这样的：

```
MEMORY 
{
	name [(attr)] : ORIGIN = ORIGIN, LENGTH = LEN
	...
}
```

memory的name，是自己的单独命名空间，所以不必担心跟section那些名字冲突。

实际例子。

```
MEMORY 
{
	rom (rx) : ORIGIN = 0, LENGTH = 256K
	ram (!rx) : org = 0x40000000, l = 4M
}
```



# section的垃圾回收

在链接的时候，加上-gc-sections选项后，链接器就会把它认为没用的section过滤掉。

这个时候，就需要使用KEEP命令来强制保留一些section。





# 参考资料

1、链接脚本语法

https://blog.csdn.net/abcamus/article/details/53509720

2、《程序员的自我修养》读书笔记——静态链接

https://segmentfault.com/a/1190000014247964

3、Linux 链接脚本分析

https://www.cnblogs.com/weidongshan/p/11125104.html