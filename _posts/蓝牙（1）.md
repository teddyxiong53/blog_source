---
title: 蓝牙（1）
date: 2018-11-28 09:37:28
tags:
	- 蓝牙
typora-root-url: ..\
---

--

是的，现在要重新学习蓝牙。借助谷歌一点点搜索来做。

# 我的理解情况

最近通过准备一个蓝牙leaudio相关的配置，在写ppt的时候，把相关的概念梳理比较清晰了。

所以写ppt做培训对我来说是最好的掌握复杂问题的方法。后续值得使用。

做ppt不用太考虑美观。重点关注内容。主要就是图文混排。这个让我想起读中学时做黑板报的经历。

然后就是经典蓝牙和ble分开看，不要混在一起看。

# 简介

当然，请看下面的简要蓝牙介绍：

| 蓝牙 |                                                            |
| ---- | ---------------------------------------------------------- |
| 定义 | 蓝牙是一种短距离无线通信技术，用于在设备之间进行数据交换。 |
| 特点 | 低功耗、成本低、易于使用、短距离通信（通常为10米以内）。   |
| 应用 | 用于连接手机、耳机、音箱、键盘、鼠标、智能家居设备等。     |
| 版本 | 蓝牙技术不断发展，目前主要版本包括蓝牙5.0和蓝牙5.1。       |
| 功能 | 数据传输、音频传输、位置服务、物联网连接等。               |
| 安全 | 支持加密和认证，以确保通信安全性。                         |
| 发展 | 蓝牙技术持续演进，不断推出新的功能和改进版本。             |

# 版本对比

| 蓝牙版本     | 5.0                   | 5.1                        | 5.2                                                          | 5.3                                            |
| ------------ | --------------------- | -------------------------- | ------------------------------------------------------------ | ---------------------------------------------- |
| 发布年份     | 2016                  | 2019                       | 2020                                                         | 2021                                           |
| 数据传输速率 | 2 Mbps                | 无显著改进                 | 引入了 LE Audio 技术                                         | 无显著改进                                     |
| 通信范围     | 室外最远 120 英尺     | 室内定位精度提升至 1 厘米  | 无显著改进                                                   | 无显著改进                                     |
| 新增功能     | 消息容量增至 255 字节 | 引入了增强型蓝牙低功耗音频 | EATT 提升数据传输效率，LC3 编解码器改善音频质量，CTKD 加强安全性。 | 引入频道分类减少干扰，周期性广告提升网络效率。 |

# 发展历史

以下是蓝牙技术的发展历史：

| 年份   | 事件                                                         |
| ------ | ------------------------------------------------------------ |
| 1994年 | 蓝牙技术由爱立信（Ericsson）公司的工程师提出，并开始研发。   |
| 1998年 | 成立了蓝牙特别兴趣小组（SIG），包括爱立信、IBM、诺基亚、东芝等公司。 |
| 1999年 | 发布了蓝牙1.0规范，标志着蓝牙技术正式问世。                  |
| 2000年 | 推出了蓝牙1.1规范，增加了对安全性和互操作性的支持。          |
| 2002年 | 发布了蓝牙1.2规范，提高了连接速度和音频质量，并引入自适应频率跳跃技术。 |
| 2004年 | 推出了蓝牙2.0规范，引入了增强数据速率（EDR）技术，提高了传输速度。 |
| 2007年 | 发布了蓝牙2.1规范，加强了对安全性和简化配对流程的支持。      |
| 2009年 | 推出了蓝牙3.0规范，引入了高速蓝牙（HSB）技术，支持Wi-Fi速率的数据传输。 |
| 2010年 | 发布了蓝牙4.0规范，引入了低功耗蓝牙（Bluetooth Low Energy，BLE）技术，用于物联网设备。 |
| 2013年 | 推出了蓝牙4.1规范，增强了对物联网设备的支持，并提高了在Wi-Fi环境下的互操作性。 |
| 2014年 | 发布了蓝牙4.2规范，提高了安全性和数据传输速度，并增加了对IPv6连接的支持。 |
| 2016年 | 推出了蓝牙5.0规范，提高了传输速度、覆盖范围和广播容量，并引入了Mesh网络支持。 |
| 2019年 | 发布了蓝牙5.1规范，增加了定向广播和定位服务等新功能，并提高了定位精度。 |
| 2020年 | 蓝牙5.2规范推出，引入LE Isochronous Channels和LE Power Control等新特性。 |

# 怎样系统学习蓝牙开发

学习蓝牙开发需要掌握以下步骤：

1. **了解基础知识：** 首先，学习蓝牙技术的基础知识，包括蓝牙的工作原理、协议栈、规范等内容。可以通过阅读相关书籍、教程或在线资源来获取这些知识。

2. **学习蓝牙协议栈：** 掌握蓝牙协议栈的结构和功能，包括物理层、链路层、射频层、L2CAP、SDP、RFCOMM、GAP、GATT 等协议。

3. **选择开发平台：** 选择合适的开发平台进行学习和实践，比如基于蓝牙模块的开发板或者软件仿真平台。

4. **学习开发工具：** 熟悉蓝牙开发所需的工具，包括调试工具、开发环境、编译器等。

5. **编写应用程序：** 使用所选平台和工具，开始编写蓝牙应用程序。可以从简单的蓝牙连接开始，逐步深入学习蓝牙数据传输、服务发现、配对认证等功能。

6. **调试和测试：** 进行调试和测试，确保应用程序的稳定性和可靠性。可以利用调试工具和模拟环境进行测试。

7. **持续学习和实践：** 蓝牙技术不断发展，需要持续学习和实践，跟进最新的技术和规范。

8. **参考资料：** 搜索蓝牙开发相关的书籍、教程、论坛、社区等资源，不断积累经验和知识。

通过系统学习和实践，您可以逐步掌握蓝牙开发的技能，成为一名优秀的蓝牙开发工程师。



# 蓝牙的工作原理

蓝牙技术的工作原理涉及到多个方面，包括无线通信、射频技术和协议栈等。以下是蓝牙的基本工作原理：

1. **无线通信：** 蓝牙技术利用无线电波在设备之间进行通信。它使用2.4 GHz ISM频段（工业、科学和医学）来进行通信，这个频段是免费的，并且被许多其他无线技术使用，因此蓝牙技术采用了频率跳跃扩频技术（FHSS）来避免干扰。

2. **射频技术：** 蓝牙技术采用了一种称为高频率调制（GFSK）的调制方式，以及快速切换频率的频率跳跃技术。这种技术可以提供较高的传输速率和稳定的连接。

3. **协议栈：** 蓝牙协议栈是蓝牙技术的核心部分，它包括物理层、链路层、射频层、逻辑链路控制与适配器协议（L2CAP）、服务发现协议（SDP）、串行端口协议（RFCOMM）、通用访问配置文件（GAP）、通用属性配置文件（GATT）等多个协议层。这些协议层共同工作，实现了蓝牙设备之间的连接、数据传输、服务发现、配对认证等功能。

4. **设备连接：** 蓝牙设备之间的连接是通过蓝牙的配对和连接过程来实现的。在配对过程中，设备之间会交换加密密钥和身份信息，以确保通信安全。一旦配对成功，设备之间就可以建立连接，并进行数据传输和控制。

总的来说，蓝牙技术通过无线通信和复杂的协议栈实现了设备之间的连接和数据传输，为各种应用场景提供了便利的无线通信解决方案。

# 蓝牙协议栈

蓝牙协议栈是蓝牙技术的核心组成部分，它负责管理蓝牙设备之间的通信和数据交换。蓝牙协议栈通常由多个层次组成，每个层次负责不同的功能。以下是蓝牙协议栈的主要层次：

1. **物理层（Physical Layer）：** 物理层负责定义蓝牙无线通信的物理特性，包括频率、调制方式、射频技术等。它决定了蓝牙设备之间的信号传输方式。

2. **链路层（Link Layer）：** 链路层负责管理蓝牙设备之间的连接，包括连接建立、维护和断开。它还负责数据的分段、组装和错误检测，以确保数据的可靠传输。

3. **逻辑链路控制与适配器协议（Logical Link Control and Adaptation Protocol，L2CAP）：** L2CAP层提供了数据的逻辑链路控制和适配，包括数据的分段、重组和流量控制。它还支持多种数据类型和服务模型，如流式传输、报文传输和消息传输。

4. **服务发现协议（Service Discovery Protocol，SDP）：** SDP层负责在蓝牙设备之间进行服务发现和描述，包括服务的类型、特性和属性等信息。它使得设备可以识别并访问其他设备提供的服务。

5. **串行端口协议（Radio Frequency Communication，RFCOMM）：** RFCOMM层提供了一种类似于串口的虚拟通信接口，用于在蓝牙设备之间建立可靠的数据通道。它使得应用程序可以通过标准串口接口进行数据传输，简化了应用开发过程。

6. **通用访问配置文件（Generic Access Profile，GAP）：** GAP层定义了蓝牙设备之间的基本通信模式和行为，包括设备的发现、连接、配对和身份认证等过程。它提供了通用的接口和规范，使得设备可以在不同厂商和环境下实现互操作性。

7. **通用属性配置文件（Generic Attribute Profile，GATT）：** GATT层定义了蓝牙设备之间的通用属性和行为，包括设备的服务、特征和描述符等。它提供了一种统一的数据模型和访问方式，用于描述和交换设备之间的数据。

通过以上层次的组合和交互，蓝牙协议栈实现了蓝牙设备之间的连接、数据传输、服务发现和控制，为各种应用场景提供了灵活、可靠的无线通信解决方案。

## 物理层特性

以下是蓝牙通信的物理层特性：

| 特性         | 描述                                                         |
| ------------ | ------------------------------------------------------------ |
| 频率范围     | 2.4 GHz                                                      |
| 调制         | GFSK（Gaussian Frequency Shift Keying）                      |
| 信道数       | 79个物理信道，每个信道1MHz带宽，不同于WiFi的13个信道         |
| 发射功率     | 典型值为0 dBm至20 dBm，取决于设备类型和规格                  |
| 数据传输速率 | 传统蓝牙可达到1 Mbps，低功耗蓝牙（Bluetooth Low Energy）可达到2 Mbps |
| 覆盖范围     | 典型范围为10米至100米，取决于发射功率和环境条件              |
| 多路径传输   | 具有抗干扰和抑制多径传输的能力                               |

这些特性可以帮助你了解蓝牙通信在物理层上的基本工作原理和规范。

### GFSK调制方法通俗解释

GFSK（Gaussian Frequency Shift Keying）是一种调制方法，它在无线通信中用于将数字数据转换成无线信号发送出去。

想象一下你在弹钢琴，每个按下的琴键都产生不同的音符。类似地，GFSK调制也是通过改变信号的频率来表示不同的数字数据。

首先，我们要选择两个频率：一个表示二进制0，另一个表示二进制1。当我们要发送一个二进制0时，我们使用一个频率；当我们要发送一个二进制1时，我们使用另一个频率。但是，我们不是突然地从一个频率跳到另一个频率，而是通过一个平滑的过渡来实现，就像音乐中的音符之间有一个平滑的过渡一样。这种平滑过渡使用高斯滤波来实现，因此称为“Gaussian”。

这种方法的好处是，在频率之间平滑地过渡可以减少信号的谱展，从而减少了对信道的要求，提高了信号的可靠性和传输效率。

### 无线通信的信道和带宽是什么？通俗解释一下

当我们谈论无线通信的信道和带宽时，可以把它们想象成在无线电频谱中的一小块空间，就像是一条高速公路上的一条车道。

- **信道**：想象一下你在高速公路上驾驶，每个车道就是一个信道。在无线通信中，信道是指在频谱中的一段特定的频率范围，用来传输数据。就像车道上的车辆一样，通过这个信道，数据可以从发送端传输到接收端。

- **带宽**：在高速公路上，车道的宽度决定了车辆可以通过的最大宽度。同样地，在无线通信中，带宽是指信道中可用的频率范围，用来传输数据。较宽的带宽意味着可以传输更多的数据，就像较宽的车道可以容纳更多的车辆。

所以，当我们说一个通信系统有多少个信道，每个信道的带宽是多少，实际上是在描述这个系统可以支持多少个并行的数据传输通路以及每个通路的传输速率。

## 蓝牙的链路层说明

蓝牙的链路层是在蓝牙协议栈中的一个重要组成部分，负责管理蓝牙设备之间的连接和数据传输。以下是对蓝牙链路层的简要说明：

- **连接管理**：链路层负责设备之间的连接建立、维护和断开。这包括扫描其他设备、响应连接请求、建立连接、保持连接活跃以及断开连接等操作。

- **数据传输**：链路层负责在连接上传输数据。它将上层的数据分成合适的数据包，并添加必要的控制信息，然后通过物理层发送到对端设备。

- **频道管理**：蓝牙链路层管理不同的物理信道，以便在连接过程中分配适当的信道进行数据传输。蓝牙设备可以在多个信道上同时进行通信，以提高通信的效率和可靠性。

- **错误处理**：链路层处理数据传输中可能出现的错误，例如丢失的数据包或者损坏的数据包。它使用一些技术来检测和纠正这些错误，以确保数据的可靠性。

总之，蓝牙的链路层扮演着连接管理、数据传输和错误处理等重要角色，是实现蓝牙通信的关键组成部分之一。

### 通俗解释一下

蓝牙的链路层就像是设备之间的沟通管理者，负责建立通信、发送和接收数据，并确保通信的顺利进行。

想象你和朋友之间的通话：首先，你们需要建立通话连接；然后，你们可以交流信息；最后，如果有什么问题，你们需要能够纠正错误或重新发送信息。在蓝牙中，链路层就是负责这些任务的“中间人”。

它的工作包括：
- 确保设备之间可以建立连接。
- 将数据正确地打包并发送到对方。
- 接收并解析对方发送的数据。
- 在必要时进行错误检测和修正，确保信息传递的准确性和完整性。

总之，链路层就是管理设备之间通信的“管家”，使得蓝牙设备可以顺利地进行数据传输和交流。

## L2CAP层通俗解释

L2CAP（Logical Link Control and Adaptation Protocol）层是蓝牙协议栈中的一个关键部分，它主要负责在不同类型的蓝牙设备之间建立数据通道和管理数据传输。

想象一下你用蓝牙耳机听音乐：音乐数据从你的手机发送到耳机，这中间就需要一个适当的通道来传输数据，并确保音乐的质量不受损害。这就是L2CAP的工作。

它的主要任务包括：
- **通道管理**：L2CAP负责在蓝牙设备之间建立数据通道，以便传输各种类型的数据，如音频、视频、文本等。
- **数据分组**：它将大块的数据分成小块，以便更高效地在蓝牙连接上传输。
- **质量控制**：L2CAP确保传输的数据在各种条件下都能保持高质量，比如在信号弱的地方也能保持音乐的流畅播放。
- **协议适配**：它还允许不同类型的蓝牙设备之间进行通信，即使它们使用不同的通信协议或数据格式。

简而言之，L2CAP就像是一个连接器，帮助不同类型的蓝牙设备之间建立连接并高效地传输各种类型的数据。

### L2CAP和链路层的关系

在蓝牙协议栈中，L2CAP（Logical Link Control and Adaptation Protocol）层位于链路层之上，是链路层的上一层。它们之间有密切的关系，但也有着不同的功能和责任。

- **链路层**：负责建立物理连接、数据传输和错误处理等基本通信任务。它处理的是底层的物理层面，如信道管理、数据包的发送和接收等。

- **L2CAP层**：位于链路层之上，提供了更高层次的抽象和控制，负责在蓝牙连接上建立逻辑通道、数据分组和协议适配等任务。它主要负责的是逻辑连接的管理和数据包的组织。

两者之间的关系可以类比为建筑中的不同楼层：链路层就像是建筑的地基和基础结构，提供了支撑和连接；而L2CAP层则是在这个基础之上构建了更高层次的功能和服务，使得通信更加灵活和多样化。

## SDP协议

SDP（Service Discovery Protocol）是蓝牙技术中的一个关键协议，用于在蓝牙设备之间发现和识别可用的服务。

想象一下你到一个新城市旅行，你想知道附近有哪些餐厅、酒店或景点。在蓝牙设备中，SDP就扮演了这样的角色，它帮助设备找到其他设备提供的各种服务，比如打印服务、文件传输服务等。

SDP的主要功能包括：
- **服务发现**：允许设备查询附近的其他设备，了解它们提供了哪些服务。
- **服务描述**：提供了关于服务的详细信息，包括服务类型、支持的特性和服务的属性等。
- **服务匹配**：帮助设备选择合适的服务进行连接和通信。

总之，SDP通过让蓝牙设备发现和识别彼此的服务，实现了设备之间的互联互通，为用户提供了更好的使用体验。

## RFCOMM协议

RFCOMM（Radio Frequency Communication）是蓝牙技术中的一个重要协议，它在蓝牙设备之间建立虚拟串口连接，使得数据的传输和交换更加简单和灵活。

想象一下你有一台电脑和一台蓝牙打印机，它们之间需要进行数据传输。==但是，蓝牙设备并不直接支持串口通信，这时就需要RFCOMM协议的帮助。==

RFCOMM的主要功能包括：
- **串口模拟**：RFCOMM模拟了传统串口通信的功能，使得蓝牙设备之间可以像串口设备一样进行数据交换。
- **多路复用**：RFCOMM允许在单个蓝牙连接上建立多个虚拟串口通道，使得可以同时进行多个不同应用程序的数据传输。
- **流控制**：RFCOMM支持流控制功能，确保数据传输的可靠性和稳定性。

总之，RFCOMM协议通过模拟串口通信的方式，为蓝牙设备之间的数据传输提供了方便和灵活性，使得不同类型的蓝牙设备可以更容易地进行数据交换和通信。

## GAP

GAP（Generic Access Profile）是蓝牙技术中的一个重要协议，定义了蓝牙设备之间的通用访问行为和规范，包括设备的广播、连接建立和连接管理等。

以手机和耳机之间的连接为例，GAP定义了手机如何搜索并连接附近的蓝牙设备，以及在连接建立后如何管理这个连接。

GAP的主要功能包括：
- **广播模式**：蓝牙设备可以在广播信号中发送自己的身份信息，比如设备名称、设备类型等，以便其他设备发现和识别。
- **连接建立**：设备可以通过扫描周围的蓝牙设备来寻找要连接的目标设备，并建立连接。
- **连接管理**：一旦连接建立，GAP定义了设备之间连接的管理方式，包括保持连接活跃、断开连接等。

总之，GAP为蓝牙设备之间的通用访问行为提供了规范，使得不同类型的蓝牙设备可以方便地进行发现、连接和通信。

## GATT

GATT（Generic Attribute Profile）是蓝牙技术中的一个关键协议，它定义了蓝牙设备之间进行数据交换的方式和规范，包括数据的组织、传输和管理等。

以智能手环和手机之间的连接为例，GATT定义了手机如何与手环之间的各种传感器和功能进行交互和通信。

GATT的主要功能包括：
- **属性和服务**：GATT将数据组织为一组属性和服务，每个服务包含一组相关的属性，用于描述设备的功能和特性。
- **特征**：属性可以进一步细分为特征，每个特征包含一个值和一组描述该值的属性。
- **数据传输**：GATT规定了如何在设备之间传输数据，包括读取、写入、通知和指示等方式。
- **连接管理**：GATT定义了连接过程中的一些管理操作，如发现服务、发现特征等。

总之，GATT为蓝牙设备之间的数据交换提供了一套灵活和规范的方式，使得不同类型的蓝牙设备可以方便地进行数据交互和功能实现。

### GAP和GATT是什么关系？会相互配合吗

GAP（Generic Access Profile）和GATT（Generic Attribute Profile）是蓝牙技术中的两个重要协议，它们在蓝牙设备之间扮演着不同的角色，但也密切相互配合。

- **GAP**：负责定义蓝牙设备的通用访问行为和规范，包括设备的广播、连接建立和连接管理等。它主要涉及设备的发现、身份识别和连接等方面。

- **GATT**：负责定义蓝牙设备之间进行数据交换的方式和规范，包括数据的组织、传输和管理等。它主要涉及设备之间数据的传输和交互。

它们的关系如下：
1. **连接建立**：==GAP负责设备之间的连接建立，而连接建立后的数据交换则由GATT协议负责。==
2. **数据交换**：一旦连接建立，GAP和GATT会相互配合，GAP提供连接的基础管理，而GATT负责具体的数据交换和通信。
3. **功能实现**：通常情况下，GAP会在连接建立后启动GATT，以实现设备之间的具体功能，比如数据传输、传感器读取等。

因此，GAP和GATT是相互配合的，它们共同构成了蓝牙设备之间的通信和功能实现的基础。

# 蓝牙连接过程

蓝牙连接过程是设备之间建立通信链路的步骤，通常包括以下几个阶段：

1. **扫描（Scanning）：** 在扫描阶段，设备会搜索附近的蓝牙设备，并监听它们发出的广播信号。这些广播信号包含了设备的基本信息和服务信息，比如设备名称、蓝牙版本、支持的服务等。

2. **广播（Advertising）：** 在广播阶段，设备会周期性地发送广播信号，以便其他设备发现和连接。广播信号包含了设备的唯一标识符和服务信息，其他设备可以根据这些信息来识别和定位设备。

3. **配对（Pairing）：** 如果两个设备需要建立安全连接，它们会进行配对过程。在配对过程中，设备会交换加密密钥和身份信息，以确保通信安全。常见的配对方法包括PIN码配对、数字证书配对和按键确认配对等。

4. **连接请求（Connection Request）：** 一旦设备发现了目标设备并完成了配对过程，它们可以发送连接请求来建立连接。连接请求包含了设备的地址和连接参数，比如连接间隔、传输速率等。

5. **连接建立（Connection Establishment）：** 在连接建立阶段，设备之间会协商连接参数，并建立通信链路。这包括确定连接间隔、协议版本、数据传输方式等。一旦连接建立成功，设备之间就可以开始进行数据交换和控制。

6. **服务发现（Service Discovery）：** 在连接建立后，设备可以通过服务发现协议（SDP）来查询对方设备提供的服务和特性。这样可以确保设备可以理解和支持对方设备提供的功能，并进行相应的数据交换。

7. **数据传输（Data Transfer）：** 一旦服务发现完成，设备之间就可以开始进行数据传输。数据传输可以采用多种方式，包括流式传输、报文传输和消息传输等。这取决于应用场景和设备支持的协议。

通过以上步骤，蓝牙设备可以建立安全可靠的连接，并进行数据交换和控制。这种连接过程使得蓝牙技术可以应用于各种场景，包括耳机、音箱、键盘、鼠标、智能家居等。

# 蓝牙规范

蓝牙规范是蓝牙技术的标准化规范，定义了蓝牙设备之间的通信协议、数据格式和行为规范。目前主要的蓝牙规范包括以下几个版本：

1. **蓝牙1.x：** 包括蓝牙1.0、1.1和1.2版本，是最早的蓝牙规范，定义了基本的蓝牙通信协议和协议栈结构。

2. **蓝牙2.x：** 包括蓝牙2.0、2.1版本，引入了增强数据速率（EDR）技术，提高了传输速度和连接质量。

3. **蓝牙3.x：** 包括蓝牙3.0版本，引入了高速蓝牙（HSB）技术，支持Wi-Fi速率的数据传输，适用于音频和视频等高带宽应用。

4. **蓝牙4.x：** 包括蓝牙4.0、4.1和4.2版本，引入了低功耗蓝牙（BLE）技术，用于物联网设备和低功耗应用，同时提高了安全性和互操作性。

5. **蓝牙5.x：** 包括蓝牙5.0、5.1和5.2版本，引入了更高的传输速率、更远的覆盖范围和更大的广播容量，同时增加了Mesh网络支持和定向广播等新特性。

每个蓝牙规范版本都包含了一系列的技术规范、测试规范和认证要求，以确保蓝牙设备之间的互操作性和稳定性。制定蓝牙规范的组织是蓝牙特别兴趣小组（SIG），由多个蓝牙技术公司组成，负责管理和更新蓝牙技术的标准化工作。



## 蓝牙的核心规范包括哪些

蓝牙技术的核心规范包括以下几个方面：

1. **物理层规范**：定义了蓝牙设备之间无线通信的物理介质和基本规范，包括频率、调制方式等。

2. **链路层规范**：定义了蓝牙设备之间建立连接和数据传输的基本协议，如蓝牙核心规范中的基础数据传输协议（Bluetooth Core Specification - Basic Rate/Enhanced Data Rate，BR/EDR）和低功耗蓝牙（Bluetooth Low Energy，BLE）规范。

3. **协议层规范**：包括各种蓝牙协议，如SDP（Service Discovery Protocol）、RFCOMM（Radio Frequency Communication）、L2CAP（Logical Link Control and Adaptation Protocol）、GATT（Generic Attribute Profile）等，用于设备之间的服务发现、数据传输和交互。

4. **应用层规范**：定义了各种蓝牙应用场景和应用协议，如音频传输（A2DP，Audio/Video Distribution Protocol）、手机配对（HFP，Hands-Free Profile）、数据同步（OPP，Object Push Profile）等，用于实现不同类型的蓝牙应用。

这些核心规范共同构成了蓝牙技术的基础，确保了蓝牙设备之间的互通性和兼容性，同时也为蓝牙应用的开发和应用提供了标准的指导和支持。



蓝牙技术规范可以分为两层：

1、核心规范。规定蓝牙必须实现的通用功能。

2、应用规范。也叫profile。可选。

结构是这样：

![](/images/蓝牙规范分层.webp)



蓝牙技术分为两种，经典蓝牙和BLE。

经典蓝牙

Basic Rate。简称BR。包括EDR和AMP两个增强技术。

Basic Rate才是最原始的蓝牙技术。这个的理论速度只能达到721.2kbps。但是要考虑到蓝牙技术诞生的时候，modem上网的速度只有56kbps。

但是时代变化太快，BR的速度很快就落伍了。怎么办？缝缝补补，推出了EDR（Enhanced Data Rate）。这个的理论速度是2.1Mbps。这种改进，还算优雅，没有什么改动就完成了。

但是WiFi的速度远高于这个，相比之下，太寒酸了。蓝牙组织就打起了WiFi的注意，借用了wifi的mac层和phy层。这个就是AMP（Alternate MAC and PHY ）。这样速度就可以达到24Mbps。

要么就使用BR/EDR，要么就用AMP，二选一。

BLE

BLE跟BR的差别特别大。基本上算两种技术了。



# ble单模和双模

ble单模就是只支持ble。

双模技术既支持ble，也支持传统蓝牙。

# 蓝牙技术的主要组织

蓝牙技术联盟，简称SIG。



# 怎样进行蓝牙抓包操作

进行蓝牙抓包操作通常需要使用专门的抓包工具或者蓝牙调试工具，以便捕获蓝牙设备之间的通信数据。以下是一般的蓝牙抓包操作步骤：

1. **选择抓包工具：** 首先，选择适合的蓝牙抓包工具。常用的工具包括Wireshark、Bluetooth HCI Logger、BTSnoop等。确保所选工具支持蓝牙抓包功能，并且可以与您的操作系统兼容。

2. **安装和配置工具：** 下载并安装所选的抓包工具，并根据需要进行配置。通常，您需要选择正确的接口和设备类型，以便工具可以正确地捕获蓝牙数据。

3. **连接蓝牙设备：** 将需要抓包的蓝牙设备与您的计算机或手机进行连接。确保设备处于活动状态，并且可以正常地进行通信。

4. **启动抓包工具：** 打开已安装的抓包工具，并开始捕获蓝牙数据。根据工具的界面和操作说明，选择正确的接口和过滤条件，以便捕获您感兴趣的数据。

5. **进行通信操作：** 在蓝牙设备之间进行通信操作，触发数据传输或者其他事件。抓包工具会记录和显示设备之间的通信数据，包括命令、响应、数据包等信息。

6. **分析抓包数据：** 完成通信操作后，停止抓包工具并保存捕获的数据。然后使用工具提供的分析功能，查看和分析捕获的数据包，以了解设备之间的通信过程和数据交换情况。

7. **调试和优化：** 根据分析结果，调试和优化蓝牙设备的通信行为。您可以根据需要进行协议分析、性能优化或者问题排查，以确保蓝牙通信的稳定性和可靠性。

通过以上步骤，您可以进行蓝牙抓包操作，并获取设备之间的通信数据，从而帮助您进行蓝牙开发、调试和优化工作。



使用手机来模拟外设，在安卓手机上可以运行一个软件：

com-ble-peripheral-sim.apk，

使用该软件可以非常方便的创建各种蓝牙外设，创建各种服务。



在实际开发中，可能使用一个手机当做中央设备。

在学习中，使用一个usb蓝牙模块，将该蓝牙模块接到pc机上，

使用pc机上的软件可以通过这个usb蓝牙模块去发现各种外设，

连接各种外设，去修改、读写外设的值。**无论是实际开发还是学习，都需要一个sniffer。**



抓包过程涉及三个软件：

a. Windows PC：Bluetooth LE Exploer

用于控制蓝牙中央设备，发起连接外设、操作外设。

从Microsoft Store安装即可。

b. Windows PC：Wireshark

抓包软件，通过Sniffer硬件来抓包。

安装、使用方法参考文档《BLE_sniffer抓包工具使用手册》

c. Android手机：com-ble-peripheral-sim.apk

BLE外设模拟软件，可以很方便地新建BLE服务。



# 蓝牙编码

总听到不少人说蓝牙音质不好、音质不行、巴拉巴拉的……，蓝牙技术通过二十多年的发展，版本迭代从1.0～5.1，其实蓝牙早已不是之前那个蓝牙了。

所以，如果你觉得蓝牙音质不好，可能有两个原因，一是设备太过于陈旧而不支持很多新的协议，二就是你是否选择了“正确的”蓝牙音频编码。

## SBC

在所有的蓝牙音频编码中，SBC音频编码是最古老的，已经有着20年的历史了，它是A2DP（Advanced Audio Distribution Profile）蓝牙音频传输协议中强制规定的一种蓝牙音频编码，因此，**所有的立体声蓝牙设备、所有的蓝牙音频芯片都会支持这个编码**。

由于无线传输的带宽有限，SBC在对每个子频段进行编码时，进行了有损处理，以达到数据压缩的目的——即经过SBC编解码以后，PCM数据发生了变化。

我们以MP3文件为例，转码过程为 MP3→PCM→SBC→PCM，因为每次转码都会损失细节，所以，**同样规格的MP3文件在无线环境下要比有线环境损失更多细节，听感也就不如有线传输了。**

人们在蓝牙音频发展的初期对其音质不看好，主要原因也是因为SBC技术自身的瓶颈所导致的。

兼容性：**通用并最基本的音频解码，几乎支持所有的蓝牙音频设备。**

音质表现：**非常一般，SBC支持44kHz/16bit音频，最高码率仅为328kbps。**

综合评价：**随着信号处理技术、半导体技术的进步，人们对SBC压缩效率低、延迟大、音质不好的抱怨越来越多，所以SBC并不是目前我们希望你去体验的蓝牙音频编码。**

# 蓝牙的各种profile

蓝牙的各种profile定义了不同类型蓝牙设备之间的通信协议和数据交换方式，以确保设备之间可以正确地进行连接和通信。以下是一些常见的蓝牙Profile：

1. **Hands-Free Profile (HFP)**：用于蓝牙耳机、车载通话等设备，允许在蓝牙设备之间进行语音通话。

2. **Advanced Audio Distribution Profile (A2DP)**：用于蓝牙音频设备，如蓝牙耳机、音箱等，允许高质量音频流的传输。

3. **Audio/Video Remote Control Profile (AVRCP)**：用于控制蓝牙音频和视频设备，如播放、暂停、跳转等控制命令。

4. **Human Interface Device Profile (HID)**：用于蓝牙键盘、鼠标等输入设备，允许在蓝牙设备之间传输输入数据。

5. **Serial Port Profile (SPP)**：用于建立虚拟串口连接，允许在蓝牙设备之间进行串口通信，适用于数据传输和控制。

6. **Object Push Profile (OPP)**：用于在蓝牙设备之间传输文件和对象，如图片、视频等。

7. **File Transfer Profile (FTP)**：类似于OPP，用于在蓝牙设备之间传输文件，但更倾向于大容量文件的传输。

8. **Phone Book Access Profile (PBAP)**：用于访问和传输电话簿数据，如联系人列表等。

9. **Message Access Profile (MAP)**：用于访问和传输消息数据，如短信、邮件等。

10. **Personal Area Network Profile (PAN)**：用于在蓝牙设备之间建立个人局域网络连接，允许设备共享网络连接和资源。

11. **Health Device Profile (HDP)**：用于医疗健康设备，允许在蓝牙设备之间传输健康数据，如心率、血压等。

以上是一些常见的蓝牙Profile，不同类型的蓝牙设备可能会支持多种Profile，以满足不同的应用场景和需求。

# 如果我要用单片机来实现一个蓝牙鼠标的功能，应该怎么做

要实现一个蓝牙鼠标的功能，您可以按照以下步骤进行：

1. **选择单片机和蓝牙模块：** 首先，选择适合的单片机和蓝牙模块。单片机需要具备足够的处理能力和IO接口，以支持鼠标的各种功能。蓝牙模块需要支持蓝牙2.1及以上版本，并且支持HID（Human Interface Device）Profile，以实现鼠标的模拟输入。

2. **连接硬件：** 将选择的单片机和蓝牙模块连接起来。通常，您需要将蓝牙模块连接到单片机的UART或者SPI接口，以实现蓝牙通信功能。

3. **编写固件程序：** 使用单片机开发工具，编写固件程序。程序需要实现蓝牙通信协议（如HID Profile），以模拟鼠标的各种操作，包括移动、点击、滚动等。同时，程序还需要处理从蓝牙模块接收到的数据，以实现与主机设备的通信。

4. **配置蓝牙模块：** 配置蓝牙模块的工作模式和参数，确保它可以正确地连接到主机设备，并且支持HID Profile。您可能需要使用AT指令或者特定的配置工具来完成这些配置。

5. **测试和调试：** 完成固件程序后，进行测试和调试。确保蓝牙鼠标可以正常地连接到主机设备，并且可以实现各种鼠标操作。您可以使用PC或者移动设备来进行测试。

6. **优化和改进：** 根据测试结果，对固件程序进行优化和改进。您可能需要调整鼠标的灵敏度、速度等参数，以提高用户体验。

7. **生产和发布：** 完成测试和优化后，准备好生产所需的材料和文档，然后进行批量生产。同时，您可以发布您的蓝牙鼠标产品，并提供相关的技术支持和售后服务。

通过以上步骤，您可以实现一个基于单片机的蓝牙鼠标功能，并将其投入生产和使用。

## 一般蓝牙鼠标里用的单片机是什么型号的

一般蓝牙鼠标里使用的单片机型号通常会因制造商和设计选择而异，但常见的选择可能包括一些低功耗、高性能的微控制器。一些常见的单片机型号包括：

1. **Nordic Semiconductor系列**：像nRF52系列是一种常见的选择，因为它们集成了Bluetooth Low Energy (BLE)和一些辅助功能，并且具有低功耗特性。

2. **Cypress PSoC系列**：Cypress的PSoC系列单片机也被广泛应用于蓝牙设备中，它们集成了蓝牙模块和其他外设，并提供灵活的可编程性。

3. **STMicroelectronics系列**：STMicroelectronics的STM32系列单片机也经常用于蓝牙鼠标等设备中，它们具有高性能和丰富的外设集成。

4. **Texas Instruments系列**：Texas Instruments的CC26xx系列也是常见的选择，具有低功耗和较高的集成度。

5. **Microchip系列**：Microchip的PIC和AVR系列单片机也有一些型号适用于蓝牙设备，它们具有广泛的生态系统和丰富的开发工具支持。

以上是一些常见的单片机型号，用于制造蓝牙鼠标等低功耗、高性能蓝牙设备。选择合适的单片机型号需要考虑功耗、性能、外设集成度、成本等因素，并且需要根据具体的应用需求进行评估和选择。

# nRF52系列介绍

Nordic Semiconductor的nRF52系列是一系列低功耗蓝牙（Bluetooth Low Energy，BLE）和多协议系统级芯片（SoC），专为物联网（IoT）应用而设计。以下是nRF52系列的一些主要特点和功能：

1. **低功耗设计：** nRF52系列芯片采用了优化的低功耗架构，具有出色的功耗表现。这使得它们适用于需要长时间运行的低功耗应用，比如智能穿戴设备、传感器节点等。

2. **多协议支持：** nRF52系列芯片支持BLE以及其他无线通信协议，如蓝牙Mesh、ANT和2.4GHz Proprietary等。这使得它们可以灵活地适应不同的应用场景和通信需求。

3. **强大的处理能力：** nRF52系列芯片内置了高性能的ARM Cortex-M4处理器，运行速度高达64MHz，配合丰富的外设和存储器，可以满足复杂的应用需求。

4. **丰富的外设集成：** nRF52系列芯片集成了丰富的外设，包括GPIO、UART、SPI、I2C、ADC、PWM等，以及模拟和数字接口，为开发者提供了灵活的硬件配置和接口选择。

5. **安全性功能：** nRF52系列芯片支持硬件加密和安全引导功能，可以保护设备和通信数据的安全性。此外，它们还支持安全的蓝牙配对和加密传输，确保通信的机密性和完整性。

6. **丰富的开发生态系统：** Nordic Semiconductor提供了丰富的开发工具和资源，包括软件开发工具链、示例代码、开发板、技术文档等，帮助开发者快速构建和部署蓝牙应用。

总的来说，nRF52系列芯片具有低功耗、高性能、多协议支持和丰富的外设集成等特点，适用于各种物联网应用，如智能穿戴设备、智能家居、传感器网络等。

## nRF52采用的是什么芯片架构

nRF52系列芯片采用了ARM Cortex-M系列的处理器架构。具体来说，nRF52系列芯片内置了ARM Cortex-M4处理器，这是一种高性能、低功耗的32位处理器核心。Cortex-M4处理器具有丰富的指令集和硬件乘法器、除法器等功能，适合用于低功耗嵌入式系统的应用场景。同时，它还支持硬件浮点运算单元（FPU），可以加速浮点运算，提高处理性能。采用Cortex-M系列处理器架构使得nRF52系列芯片具有出色的处理能力和低功耗特性，适用于各种物联网和嵌入式应用。

## nrf52开发环境搭建

搭建nRF52开发环境通常包括以下步骤：

1. **安装开发工具：** 首先，您需要安装适用于nRF52系列的开发工具。常用的开发工具包括Nordic Semiconductor官方提供的nRF5 SDK和Segger Embedded Studio等。

2. **获取SDK和文档：** 下载并安装nRF5 SDK，该SDK包含了一系列的示例代码、库文件和文档，帮助您快速开始开发。此外，您还可以下载相应版本的nRF52系列芯片的数据手册和技术参考手册，以便了解芯片的详细信息和功能。

3. **配置开发环境：** 根据您的开发工具和平台，配置相应的开发环境。如果使用Segger Embedded Studio，您需要设置工程路径、选择编译器、配置调试器等。

4. **选择开发板：** 准备一块nRF52系列的开发板，例如nRF52840 Development Kit或者nRF52833 Development Kit。这些开发板通常包含了nRF52系列芯片、外围器件、调试接口等，方便您进行开发和调试。

5. **编写和调试代码：** 使用开发工具创建一个新的工程，然后编写您的应用代码。您可以利用SDK提供的示例代码作为参考，或者根据您的需求编写自己的代码。编写完成后，您可以进行代码调试和验证。

6. **编译和下载：** 在编写完成后，使用开发工具进行代码编译，并生成可执行文件。然后，通过调试器将可执行文件下载到目标设备（开发板）中进行测试。

7. **测试和验证：** 在下载完成后，将开发板连接到计算机，并进行功能测试和验证。确保您的应用程序能够正常运行，并且符合您的设计要求。

8. **优化和发布：** 完成测试和验证后，进行性能优化和代码调整。最终，您可以将应用程序发布到目标设备中，并准备进行生产和部署。

通过以上步骤，您可以搭建nRF52开发环境，并开始进行开发和调试工作。

# PSM

协议/服务复用(PSM)： 2个字节(最小)

PSM段结构以地址段的ISO3309扩展机制为基础。

==所有PSM值都必须是奇数，== 

也就是最低位字节的最低位必须为"1"。

而且，所有PSM值的最高字节的最低位应等于"0"。 

这样PSM段将可以扩展到16位以上。 

PSM值被分成两部分， 

第一部分的值有蓝牙SIG及其协议分配。

 第二部分的值则可以动态分配,并与服务搜索协议（SDP）一起使用。

动态分配的值可以用于支持一个特定协议的多种执行版本。

 ```
#define BT_PSM_SDP                      0x0001
#define BT_PSM_RFCOMM                   0x0003
#define BT_PSM_TCS                      0x0005
#define BT_PSM_CTP                      0x0007
#define BT_PSM_BNEP                     0x000F
#define BT_PSM_HIDC                     0x0011
#define BT_PSM_HIDI                     0x0013
#define BT_PSM_UPNP                     0x0015
#define BT_PSM_AVCTP                    0x0017
#define BT_PSM_AVDTP                    0x0019
#define BT_PSM_AVCTP_13                 0x001B /* Advanced Control - Browsing */
#define BT_PSM_UDI_CP                   0x001D /* Unrestricted Digital Information Profile C-Plane  */
#define BT_PSM_ATT                      0x001F /* Attribute Protocol  */
 ```

# 【蓝牙系列】蓝牙5.4到底更新了什么?（1）--- PAwR

https://blog.csdn.net/hesuping/article/details/129393501

# gap和sdp是什么关系

GAP负责设备之间的连接和管理，而SDP负责服务的发现和描述。

sdp需要在连接建立之后。

# gap安全级别

GAP（Generic Access Profile）定义了蓝牙设备之间的连接和访问控制，其中包括安全级别。GAP安全级别分为以下几种：

| 安全级别 | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| 0        | 无安全性（No Security）：不要求身份验证或加密。              |
| 1        | 无认证的配对（Unauthenticated pairing with encryption）：设备配对时不需要用户确认，但通信数据是加密的。 |
| 2        | 有认证的配对（Authenticated pairing with encryption）：设备配对时需要用户确认（如输入PIN码或确认数字配对），通信数据是加密的。 |
| 3        | 有认证且加密的配对（Authenticated LE Secure Connections pairing with encryption）：使用LE Secure Connections，提供更高的安全性，包括MITM（Man-in-the-Middle）保护。 |

这些安全级别确保了蓝牙设备之间的数据传输的安全性，防止未经授权的访问和数据窃听。



# ble的广播分析

在BLE协议中，广播通信主要有两类使用场景：

1）单一方向的、无连接的数据通信，数据发送者在广播信道上广播数据，数据接收者扫描、接收数据。

2）连接的建立。

后续的分析，将围绕这两个使用场景展开。

在BLE协议中，和广播通信相关的协议层次比较简单，主要包括：

> GAP-------->HCI-------->LL

LL(Link Layer)位于最底层，负责广播通信有关功能的定义和实现，包括物理通道的选择、相关的链路状态的定义、PDU的定义、设备过滤（Device Filtering）机制的实现等。

HCI负责将LL提供的所有功能，以Command/Event的形式抽象出来，供Host使用。

GAP负责从应用程序的角度，抽象并封装LL提供的功能，以便让应用以比较傻瓜的方式进行广播通信。当然，这不是必须的，也就是说，我们可以在没有GAP参与的情况下，进行广播通信。



在某一个时刻，参与广播通信的BLE设备，从LL的角度看，可以处于如下三种状态的一种：

> Advertising，数据发送方，周期性的发送广播数据；
>
> Scanning，数据接收方，扫描、接收广播数据；
>
> Initiating，连接发起方，扫描带有“可连接”标志的广播数据，一旦发现，则发起连接请求（都是由Link Layer自动完成，不需要Host软件参与）。

Link Layer中广播通信有关的功能介绍完之后，HCI这一层就简单了，因为它仅仅是将Link Layer所提供的功能封装成特定的Command和Event，没有任何逻辑可言。

对于广播通信而言，GAP主要完成两个事情：

> 1）将Link Layer的“协议语言”，如Advertising、Scannin、Initiating等，转换为更为直观的“人类语言”（当然，要进行一些封装）。
>
> 2）为广播数据和扫描应答数据，定义一些统一的、规范的格式，以达到互联互通的目的。

下面将分别介绍这两个事情。







蓝牙协议规定了两个层次的协议，分别为蓝牙核心协议（Bluetooth Core）和蓝牙应用层协议（Bluetooth Application）。

蓝牙核心协议关注对蓝牙核心技术的描述和规范，它只提供基础的机制，并不关心如何使用这些机制；

蓝牙应用层协议，是在蓝牙核心协议的基础上，根据具体的应用需求，百花齐放，定义出各种各样的策略，如FTP、文件传输、局域网等等。



Bluetooth Core由两部分组成，Host和Controller。

这两部分在不同的蓝牙技术中（BR/EDR、AMP、LE），承担角色略有不同，但大致的功能是相同的。

Controller负责定义RF、Baseband等偏硬件的规范，并在这之上抽象出用于通信的逻辑链路（Logical Link）；

Host负责在逻辑链路的基础上，进行更为友好的封装，这样就可以屏蔽掉蓝牙技术的细节，让Bluetooth Application更为方便的使用。



在一个系统中，Host只有一个，但Controller可以一个，也可以有多个。

如：

单独的LE Controller；

单独的BR/EDR Controller；

单独的LE+BR/EDR Controller；

在单独的BR/EDR Controller或LE+BR/EDR Controller基础上，增加一个或多个额外的AMP Controller。





BLE的Link Layer会从剩余的37个Physical Channel中，选取一个，为这种场景里面的通信双方建立单独的通道（data channel）。这就是连接（connection）的过程。

同时，为了增加容量，增大抗干扰能力，连接不会长期使用一个固定的Physical Channel，而是在多个Channel（如37个）之间随机但有规律的切换，这就是BLE的跳频（Hopping）技术。



# 蓝牙跳频的有多频繁，用实际数据举例说明

蓝牙使用跳频技术（Frequency Hopping Spread Spectrum, FHSS）来增强信号的抗干扰能力和提高数据传输的安全性。在蓝牙通信过程中，设备会在多个预定义的信道上频繁切换，从而减少单一信道受到干扰的概率。

### 1. **跳频速率**

蓝牙经典（BR/EDR）和蓝牙低功耗（BLE）都使用跳频技术，但跳频的方式和速率有所不同：

- **蓝牙经典（BR/EDR）**：在2.4 GHz ISM频段使用79个1 MHz的信道。设备每625微秒（µs）跳一次频，即**每秒跳频1600次**。
- **蓝牙低功耗（BLE）**：在2.4 GHz ISM频段使用40个2 MHz的信道。跳频速率取决于具体的连接参数和设备配置，但典型跳频速率在**每秒1600次**或更低。

### 2. **实际例子**

- **蓝牙经典设备**：在进行音频传输时，比如使用蓝牙耳机播放音乐，设备会在79个信道中以每秒1600次的频率跳频。例如：
  - 假设当前在第5信道传输，625微秒后可能会跳到第45信道，接着625微秒后再跳到第10信道，如此循环。
- **蓝牙低功耗设备**：例如在连接两个BLE设备进行数据传输时，设备可能在40个信道中以每秒1600次或更低的频率跳频。具体频率取决于连接间隔和其他参数设置。

### 3. **跳频序列**

蓝牙设备使用一种伪随机跳频序列来决定跳频的顺序，这个序列由主设备（通常是手机、电脑等）根据连接参数生成，并同步到从设备（如耳机、鼠标等）。这个伪随机序列确保了信道的使用是均匀分布的，减少了干扰的概率。

### 4. **抗干扰性和安全性**

- **抗干扰性**：频繁跳频使得蓝牙信号在一个特定的信道上停留时间很短，因此如果某个信道受到干扰，设备会很快跳到另一个信道继续通信，降低干扰的影响。
- **安全性**：频繁跳频还增加了窃听和拦截的难度，因为窃听设备必须知道跳频序列并同步跳频才能有效拦截数据。

### 总结

蓝牙设备通过每秒数千次的频繁跳频，实现了在众多信道之间的快速切换。这种机制提高了抗干扰能力和数据传输的安全性。经典蓝牙每秒跳频1600次，而BLE的跳频速率取决于具体的应用和配置，一般也是每秒1600次或更低。

# 参考资料

1、蓝牙技术基础知识学习

https://www.jianshu.com/p/78460132a563

2、蓝牙模块——基础知识介绍

https://blog.csdn.net/wwt18811707971/article/details/77833602

3、

https://zhuanlan.zhihu.com/p/150523748