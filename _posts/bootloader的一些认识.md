---
title: bootloader的一些认识
date: 2018-04-16 16:42:33
tags:
	- bootloader

---

--

我以前做单片机开发，完全没有bootloader这个概念。

后面做linux开发，用的bootloader一直是uboot。

现在看esp8266的板子。这里也有bootloader的概念在。

要在bootloader里，做到这些：
1、初始化flash，提供读写接口。
2、初始化串口，从CH340接收数据。

如果有jtag，可以不依赖软件，就完成数据传输和写入的操作。

我以前的单片机开发就是这个。

esp8266的bootloader的固化了的。一般不让改。有bootloader，就可以不用jtag来辅助开发，下载程序就方便很多。



# 给stm32写一个bootloader

为STM32编写一个 bootloader 是一个复杂的任务，因为它涉及到与硬件、存储器、通信接口等多个方面的交互。下面是一个简化的C语言示例代码，用于演示一个基本的STM32 bootloader，供参考。请注意，实际的 bootloader 会更复杂，需要考虑更多的安全性和错误处理。

以下示例代码是一个基本的UART bootloader，它通过串口通信接口接收新固件，并将其写入到STM32的闪存中。这个示例假设您已经熟悉STM32的编程和串口通信。

```c
#include <stdint.h>

// 定义启动地址，即固件的入口点
#define APP_START_ADDRESS 0x08008000

// 函数指针类型，用于调用新固件的入口点
typedef void (*application_t)(void);

// 串口初始化函数，用于与计算机通信
void uart_init() {
    // 在这里初始化串口硬件
}

// 串口接收函数，用于接收新固件数据
uint8_t uart_receive_byte() {
    // 从串口接收一个字节的数据
    // 在这里实现串口接收功能
}

// 闪存擦除函数，用于擦除闪存扇区
void flash_erase_sector(uint32_t sector_address) {
    // 在这里实现擦除指定扇区的功能
}

// 闪存编程函数，用于将数据编程到闪存
void flash_program(uint32_t address, uint8_t* data, uint32_t length) {
    // 在这里实现将数据编程到指定地址的闪存功能
}

int main() {
    // 初始化串口通信
    uart_init();

    // 等待接收新固件的开始命令
    // 在这里添加逻辑，等待开始命令的触发

    // 擦除应用程序区域的闪存
    flash_erase_sector(APP_START_ADDRESS);

    // 开始接收固件数据并编程到闪存
    uint32_t address = APP_START_ADDRESS;
    while (1) {
        uint8_t byte = uart_receive_byte();
        if (byte == 0x00) {
            // 接收结束标志，退出循环
            break;
        }
        flash_program(address, &byte, 1);
        address += 1;
    }

    // 关闭串口通信
    // 在这里添加逻辑，关闭串口通信

    // 跳转到新固件的入口点
    application_t app_start = (application_t)APP_START_ADDRESS;
    app_start();

    while (1) {
        // 这里可以添加其他应用程序逻辑
    }

    return 0;
}
```

请注意，这个示例非常基础，仅用于演示 bootloader 的核心功能。在实际的应用中，您需要更多的安全性措施，错误处理和恢复机制，以确保 bootloader 可靠性和安全性。另外，STM32的不同型号可能具有不同的硬件和闪存编程方式，因此需要根据目标硬件的规格进行适当的修改和测试。最好查看STM32的文档和示例代码，以获取更多关于 bootloader 的信息。

# 单片机的bootrom

单片机的 Boot ROM（引导只读存储器）是一个特殊的只读存储器区域，通常内置在芯片中，并包含在单片机的硬件设计中。Boot ROM 的主要目的是在单片机上电时执行引导程序，以确保正确启动芯片，并可能包含用于加载和执行应用程序的基本引导加载程序。以下是关于单片机 Boot ROM 的一些重要信息：

1. **启动过程**：当单片机上电或复位时，处理器会自动跳转到 Boot ROM 的起始地址，执行其中的引导代码。这个过程是单片机的启动序列，用于确保芯片进入正常工作状态。

2. **功能**：Boot ROM 的功能因单片机型号和制造商而异，但通常包括以下内容：
   - 初始化处理器和外设。
   - 检查外部引导条件，例如引导模式选择开关或引导引脚状态。
   - 从外部引导设备（例如串口或闪存）加载引导加载程序或应用程序。
   - 执行引导加载程序或应用程序。
   - 支持多种引导模式，如串口引导、SPI引导、USB引导等，具体取决于芯片的能力。

3. **保持不变性**：Boot ROM 的内容通常由制造商固化在芯片上，用户通常无法更改或覆盖它。这确保了引导过程的可靠性和一致性。

4. **引导加载程序**：有些单片机的 Boot ROM 包含一个基本的引导加载程序，该程序可以加载外部存储器（如闪存）中的用户应用程序。这种引导加载程序通常具有一些通用性，可以与多种存储器和通信接口配合使用。

5. **用途**：Boot ROM 对于芯片的生产测试和编程非常有用，因为它确保了在芯片上电后可以正确地进行初始化和加载应用程序。它还可以用于恢复芯片的正常工作状态，即使用户应用程序出现问题也能够进行恢复。

需要注意的是，单片机的 Boot ROM 功能和用法因制造商和型号而异。因此，要充分了解特定单片机的 Boot ROM，最好查阅该型号的数据手册和参考手册，以获取详细的信息和使用指南。