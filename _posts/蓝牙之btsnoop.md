---
title: 蓝牙之btsnoop
date: 2024-06-06 15:55:28
tags:
	- 蓝牙
---

# 简介

`btsnoop` 是一个用于捕获和分析蓝牙通信数据的工具。它通常用于调试和分析蓝牙协议，类似于网络上的 Wireshark。`btsnoop` 捕获的数据可以使用 Wireshark 等工具进行分析。以下是 `btsnoop` 工具的基本介绍和使用方法：

1. **功能**：
   
   - 捕获蓝牙协议数据包
   - 分析蓝牙通信
   - 调试蓝牙应用程序
   
2. **工作原理**：
   `btsnoop` 工具会捕获通过蓝牙传输的数据包，并将其存储在一个文件中。这个文件可以使用 Wireshark 等网络分析工具进行详细分析。

3. **使用步骤**：

   1. **启用 btsnoop 日志**：
      - 对于 Android 设备：
        在 Android 设备上，可以通过启用开发者选项中的“Enable Bluetooth HCI snoop log”来捕获蓝牙日志。捕获的日志通常存储在 `/sdcard/btsnoop_hci.log`。

      - 对于 Linux 系统：
        在 Linux 上，可以通过配置蓝牙协议栈（例如 BlueZ）来启用 `btsnoop` 日志。编辑 BlueZ 配置文件 `/etc/bluetooth/main.conf`，添加或修改以下内容：
        
        ```ini
        [General]
        EnableSnoopLog = true
        ```
      
   2. **捕获数据**：
      - 启用日志后，重新启动蓝牙服务或设备。
      - 执行蓝牙操作（例如配对、连接、数据传输），这些操作将被记录在 `btsnoop` 日志文件中。

   3. **分析数据**：
      - 将捕获的 `btsnoop` 日志文件传输到计算机。
      - 使用 Wireshark 打开日志文件进行分析。Wireshark 可以识别和解码大多数蓝牙协议，如 HCI、L2CAP、RFCOMM、ATT 等。

4. **示例**：

   假设已经捕获了一个名为 `btsnoop_hci.log` 的日志文件，可以使用 Wireshark 打开并分析这个文件：
   - 打开 Wireshark
   - 选择 `File` -> `Open`，然后选择 `btsnoop_hci.log` 文件
   - Wireshark 将解析文件并显示捕获的数据包列表，用户可以进一步分析每个数据包的详细信息。

5. **常见用途**：
   - 调试蓝牙应用程序和设备
   - 分析蓝牙连接和通信问题
   - 研究和学习蓝牙协议

通过使用 `btsnoop` 工具，开发人员和研究人员可以深入了解蓝牙通信的细节，从而更好地开发和调试蓝牙应用程序和设备。

# 说明

`btsnoop` 是蓝牙协议栈中的一个数据捕获工具或日志文件格式，主要用于记录蓝牙通信的详细信息。它在调试和分析蓝牙通信问题时非常有用，尤其是在蓝牙协议栈开发、应用开发和性能优化中。

以下是 `btsnoop` 的相关说明：

------

**1. btsnoop 文件格式**

- **用途**：记录蓝牙设备间的通信数据包，包括发送和接收的 HCI 数据包。
- **内容**：通常包括数据包时间戳、方向、包类型和内容（如 HCI 命令、HCI 事件、ACL 数据）。
- **兼容性**：文件格式类似于网络数据包捕获工具 Wireshark 的 PCAP 文件格式，因此可以直接用 Wireshark 打开并解析。

------

**2. 文件内容结构**

- **头部**：
  - 文件开头包含固定的 16 字节头部，用于描述文件格式和版本。
  - 示例：
    - `0x6274736E` ("btsn") 标识文件类型。
    - 4 个字节的版本号（常见值为 0x01）。
    - 时间戳格式描述。
- **数据包记录**：
  - 每个数据包条目由以下部分组成：
    - **时间戳**：记录数据包的捕获时间。
    - **方向**：数据包方向，分为发送（Host to Controller）和接收（Controller to Host）。
    - **类型**：数据包类型（如 HCI 命令、ACL 数据包、SCO 数据包、事件等）。
    - **内容**：数据包的实际内容（原始字节）。

------

**3. 数据包方向**

- 发送 (Host to Controller)

  ：

  - 从主机（通常是操作系统或应用程序）发送到蓝牙控制器（芯片）。

- 接收 (Controller to Host)

  ：

  - 从蓝牙控制器发送到主机。

方向的标识：

- `0x00` 或 `0x02`：主机发送数据。
- `0x01` 或 `0x03`：主机接收数据。

------

**4. 捕获工具** 蓝牙协议栈开发环境通常提供工具生成 `btsnoop` 日志，例如：

- Android

  ：

  - 蓝牙日志可以通过 

    ```
    adb
    ```

     获取：

    ```bash
    adb shell setprop persist.bluetooth.btsnoop true
    adb pull /data/misc/bluetooth/logs/btsnoop_hci.log
    ```

- Linux

  ：

  - BlueZ 支持记录 HCI 数据包，可以用 

    ```
    btmon
    ```

     工具生成类似日志。

    ```bash
    btmon > btsnoop.log
    ```

------

**5. 分析工具** 可以使用以下工具打开 `btsnoop` 日志进行分析：

- Wireshark

  ：

  - 支持蓝牙协议的解码，能解析 HCI 命令、ACL 数据、L2CAP、RFCOMM、GATT 等。

- HCI Snoop Log Viewer

  ：

  - Android 平台专用工具，用于分析特定问题。

------

**6. 使用场景**

| **场景**     | **说明**                                                     |
| ------------ | ------------------------------------------------------------ |
| **协议调试** | 查看 HCI 命令是否发送正确，检查蓝牙握手或连接流程是否正常。  |
| **性能分析** | 分析蓝牙通信延迟、数据包重传等性能问题。                     |
| **问题排查** | 定位蓝牙断连、通信中断、配对失败等问题。                     |
| **开发调试** | 检查协议栈实现是否符合蓝牙规范，如 ACL 数据流或 GATT 请求响应。 |

------

**注意事项**

- `btsnoop` 文件可能包含敏感信息（如设备地址和数据），需要注意隐私保护。
- 长时间记录可能导致日志文件过大，需要定期清理。
