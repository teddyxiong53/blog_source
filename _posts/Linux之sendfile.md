---
title: Linux之sendfile
date: 2023-10-13 11:48:11
tags:
	- Linux

---

--

# 简介

`sendfile` 是一个用于在 Linux 系统中优化网络传输性能的系统调用。

它允许将一个文件的内容从一个文件描述符复制到另一个文件描述符，

通常是用于在网络套接字上发送文件内容，

==而无需显式地将数据从内核空间复制到用户空间，从而提高了性能。==

`sendfile` 的基本原理是将数据直接从文件描述符（通常是一个文件）传输到另一个文件描述符（通常是一个套接字）。

==这是通过操作系统的内核缓冲区来完成的，==

而不需要通过用户空间来复制数据。

以下是 `sendfile` 的函数原型：

```c
#include <sys/sendfile.h>

ssize_t sendfile(int out_fd, int in_fd, off_t* offset, size_t count);
```

- `out_fd`：表示数据传输的目标文件描述符，通常是一个套接字描述符。
- `in_fd`：表示数据源文件描述符，通常是一个文件描述符。
- `offset`：表示数据源文件的偏移量，通常设置为 NULL，表示从文件的当前偏移量开始读取数据。
- `count`：表示要传输的字节数。

`sendfile` 的主要优势包括：

1. **零拷贝**：`sendfile` 避免了在用户空间和内核空间之间不必要的数据拷贝，从而提高了性能。

2. **低 CPU 使用率**：由于数据传输由操作系统内核处理，应用程序的 CPU 使用率较低。

3. **高效的文件传输**：`sendfile` 特别适用于将文件内容传输到网络套接字，例如，用于向客户端提供文件下载服务。

需要注意的是，

`sendfile` 并不是 POSIX 标准的一部分，

因此不是跨平台的解决方案，

而且其行为在不同操作系统上可能有所不同。



通常，它在 Linux 等支持它的系统上表现最佳。

在一些情况下，也可以使用其他系统调用（如 `write` 和 `read`）以较低级别的方式实现相似的功能，但 `sendfile` 通常提供了更高效的方法。