---
title: Linux内核之might_sleep
date: 2020-08-29 14:55:25
tags:
	- Linux

---

--

*might_sleep():* 指示当前函数可以睡眠。

如果它所在的函数处于原子上下文*(atomic context)*中*(*如，*spinlock, irq-handler…)*，将打印出堆栈的回溯信息。

**这个函数主要用来做调试工作，**在你不确定不期望睡眠的地方是否真的不会睡眠时，就把这个宏加进去。



Linux内核中的`might_sleep()`函数是一个帮助开发人员检测睡眠情况的宏或函数。

睡眠是指在内核代码中需要等待某种条件满足或需要释放CPU以等待某些事件时所发生的操作。

通常，睡眠会导致当前的内核线程（或进程）放弃CPU，以便其他线程可以执行。

==`might_sleep()`函数通常用于调试目的，而不是在正常的生产内核代码中使用。==

它有两种变体：`might_sleep()`和`might_sleep_if()`。

1. **`might_sleep()`：** 这是一个宏，通常用于注释内核代码，以提醒开发人员在特定的上下文中可能发生睡眠操作。它不会引入实际的睡眠操作，而只是提醒开发人员要小心处理可能导致睡眠的情况。

    ```c
    might_sleep();
    ```

2. **`might_sleep_if()`：** 这是一个函数，允许在特定条件下触发实际的睡眠操作。如果条件为真，它会引入一个内核可能会进入睡眠状态的警告。

    ```c
    might_sleep_if(condition);
    ```

这些函数和宏的目的是帮助内核开发人员识别可能导致死锁或不确定行为的情况。在内核中，不同上下文和调用栈中可能会有不同的规则和约束，以确定是否可以进行睡眠操作，因此，`might_sleep()`和`might_sleep_if()`用于提醒开发人员注意潜在的问题。

注意：`might_sleep()`和`might_sleep_if()`通常在内核代码中用于调试和开发目的。不应该在生产环境中使用它们，因为它们只是提供了一种检测潜在问题的方法，而不是解决问题的方法。在编写内核代码时，开发人员应该遵循内核的睡眠规则和最佳实践，以避免死锁和不确定行为。





# 参考资料

1、

https://blog.csdn.net/freeandperson/article/details/84426031