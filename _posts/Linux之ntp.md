---
title: Linux之ntp
date: 2018-07-23 09:38:53
tags:
	- Linux

---



为了避免Linux长时间运行后，时间不同步。所以需要ntp服务来进行时间同步。

# ntp和sntp关系

NTP（Network Time Protocol）和 SNTP（Simple Network Time Protocol）是两种用于网络时间同步的协议，它们之间有一定的关系。

NTP 是一种用于分布式网络环境中的时间同步协议。它通过在计算机之间传输时间信息，使得网络中的所有计算机都能够以高精度和一致性的方式保持时间同步。NTP 在网络中建立一个时间服务器和时间客户端的体系结构，时间服务器负责提供准确的时间信息，而时间客户端通过与时间服务器通信来同步本地时间。

**SNTP 是 NTP 的一个简化版本，它更加轻量级且易于实现。**SNTP 的目标是提供一种简单的时间同步解决方案，适用于资源受限的设备或特定应用场景。相对于 NTP，SNTP 省略了一些复杂的功能和算法，仅提供基本的时间同步功能。

**NTP 和 SNTP 的关系可以理解为 SNTP 是 NTP 的子集。**SNTP 基本上采用了 NTP 的核心机制和数据包格式，但在协议功能和精度方面进行了简化。SNTP 可以作为 NTP 的替代方案，特别适用于一些对时间同步要求不高、资源受限或需要简单实现的场景。

总结起来，NTP 是一种功能丰富的网络时间同步协议，而 SNTP 是 NTP 的简化版本，适用于对时间同步要求不高的场景。

# ntpd代码架构分析

`ntpd`是网络时间协议守护进程（Network Time Protocol Daemon）的简称，它是实现NTP协议的服务程序，用于同步网络中各个计算机的时间。`ntpd`通常运行在类Unix系统上，例如Linux、BSD等，它是NTP协议实现中最常用的服务端软件。
`ntpd`的代码架构分析通常包括以下几个主要部分：
1. **协议栈**：`ntpd`实现了NTP协议的通信部分，包括数据包的发送和接收，以及对NTP协议版本的支持。它处理来自客户端的同步请求，同时也作为客户端向其他时间服务器请求时间。
2. **时间管理**：`ntpd`管理本地系统的时间，并根据网络中其他时间源的信息调整系统时钟。这包括时钟的频率调整和时间偏差的校正。
3. **同步算法**：`ntpd`使用复杂的算法来选择最佳的时间源，并计算时间偏差和延迟。这些算法可以处理网络延迟的不确定性，并过滤掉不可靠的时间源。
4. **配置和监控**：`ntpd`允许通过配置文件进行设置，包括时间服务器的地址、访问控制策略等。它还提供了监控和统计功能，以便系统管理员可以检查同步状态和性能。
5. **安全和防护**：`ntpd`实现了多种安全特性，包括加密认证和对时间篡改的防护措施，以防止恶意的时间同步攻击。
6. **系统接口**：`ntpd`与操作系统交互，读取和设置系统时间，并且可能需要特殊权限来执行这些操作。
在分析`ntpd`的代码时，需要考虑到它的模块化设计，其中每个部分都是相互独立而又协同工作的。代码的架构可能包括多个源文件，每个文件负责实现不同的功能模块。了解这些模块之间的关系和相互作用对于理解`ntpd`的整体工作原理至关重要。
由于`ntpd`是一个开源项目，你可以通过查看其源代码来深入了解其架构。源代码通常可以在项目的官方网站或者代码托管平台上找到，例如GitHub或GitLab。在分析代码时，注意遵守相关的开源协议和知识产权法律法规。

# *CHU clock*

CHU clock 指的是加拿大时间信号发射台（CHU）所提供的精确时间信号服务。

CHU 是一个由加拿大政府运营的时间信号发射台，

位于加拿大安大略省的渥太华。

它通过短波无线电、电话和其他方式提供时间信号服务，是全球最准确的时间信号源之一。

CHU clock 通过短波无线电广播多个频率上的时间信号，

这些信号可以被具有相应接收功能的时钟或计时设备接收并同步。

这些信号通常包括时间编码，可以通过音频或其他方式解码，以获取当前的精确时间信息。

CHU 提供的时间信号服务对于需要高度精确时间同步的应用非常重要，

例如科学研究、电信、导航和电力系统等。

# ntp协议版本

网络时间协议（NTP）是一种用于同步计算机时钟的协议。自1985年首次引入以来，NTP已经经历了多次修订，以改进其功能、效率和安全性。以下是一些主要的NTP协议版本：
1. NTPv1（RFC 958）：这是NTP的第一个版本，它定义了基本的时间同步机制，但未广泛使用。
2. NTPv2（RFC 1059和RFC 1119）：这是NTP的第二个版本，它引入了一些改进，例如更精确的时间同步算法和参考时间源的选择。
3. NTPv3（RFC 1305）：这是NTP的第三个版本，也是第一个广泛使用的版本。它进一步改进了同步算法，增加了对多种参考时间源的支持，并引入了更复杂的过滤和选择算法来提高准确性。
4. NTPv4（RFC 5905）：这是NTP的当前版本，它包含了自NTPv3以来的所有改进，并增加了一些新功能，例如对自动键管理（Autokey）的支持，以及对NTP控制消息的改进。NTPv4还强调了安全性，包括对NTP消息的加密认证。
NTPv4是目前最广泛使用的版本，它提供了高精度的时间同步，并且支持多种操作系统和网络环境。随着网络安全性的日益重要，NTPv4的加密和认证功能也变得越来越重要。
值得注意的是，NTP的版本号通常不会在协议消息中明确标识，而是通过支持特定版本的功能和改进来识别。因此，当提到“NTP协议版本”时，通常指的是协议的实现和支持的功能集，而不仅仅是版本号。

# 启动了ntpd服务，但是时间没有同步

如果你已经启动了 NTP 服务，但时间仍然没有同步，可能有几个原因导致这种情况发生。以下是一些可能的解决方法：

1. **检查网络连接：** 确保你的设备能够连接到互联网，并且可以与 NTP 服务器进行通信。你可以尝试使用 `ping` 命令测试是否可以访问 NTP 服务器。

   ```bash
   ping pool.ntp.org
   ```

   如果无法 ping 通 NTP 服务器，则可能存在网络连接问题，需要检查网络设置和防火墙配置。

2. **检查 NTP 服务器配置：** 确保在配置文件中指定了正确的 NTP 服务器地址。你可以在 Yocto 的配置文件中检查 `NTP_SERVER` 变量的设置。

3. **查看日志信息：** 检查系统日志以查看 NTP 服务是否有任何错误消息或警告。你可以使用 `journalctl` 命令来查看系统日志。

   ```bash
   journalctl -u ntpd
   ```

   如果在日志中发现任何与 NTP 同步相关的错误消息，可以根据日志内容采取进一步的行动。

4. **手动同步时间：** 你也可以尝试手动启动 NTP 同步来检查是否存在问题。可以使用 `ntpd` 命令手动启动 NTP 同步。

   ```bash
   ntpd -q -g
   ```

   `-q` 参数表示执行一次单独的时间同步查询，`-g` 参数表示强制进行时间同步。执行此命令后，等待一段时间并检查系统时间是否有变化。

5. **检查硬件时钟：** 最后，确保硬件时钟的时间是正确的。有时候，即使 NTP 服务已经正确配置并运行，硬件时钟也可能存在偏差，导致时间同步的问题。你可以使用 `hwclock` 命令来查看和调整硬件时钟。

   ```bash
   hwclock --show
   ```

   如果硬件时钟与系统时间不匹配，你可以使用 `hwclock --systohc` 命令将系统时间写入硬件时钟。

通过执行以上步骤，你可以诊断和解决 NTP 同步问题，并确保系统时间正确同步。

# 鸟哥的文章

http://cn.linux.vbird.org/linux_server/0440ntp/0440ntp-centos4.php

# NTP详解

在计算机的世界里，时间非常地重要，

例如对于火箭发射这种科研活动，

对时间的统一性和准确性要求就非常地高，

是按照A这台计算机的时间，还是按照B这台计算机的时间？

NTP就是用来解决这个问题的，

NTP（Network Time Protocol，网络时间协议）是用来使网络中的各个计算机时间同步的一种协议。

它的用途是把计算机的时钟同步到世界协调时UTC，

其精度在局域网内可达0.1ms，

==在互联网上绝大多数的地方其精度可以达到1-50ms。==

标准时间，是由[原子钟](https://baike.baidu.com/item/原子钟)报时的国际标准时间UTC（Universal Time Coordinated，世界协调时）。

所以NTP获得UTC的时间来源可以是原子钟、天文台、卫星，也可以从Internet上获取。



有了准确而可靠的的时间源，那这个时间如何传播呢？

在NTP中，定义了时间按照服务器的等级传播，

==按照离外部UTC源远近==将所有的服务器归入不同的Stratum（层）中，

例如把通过GPS（Global Positioning System，全球定位系统）取得发送标准时间的服务器叫Stratum-1的NTP服务器，

而Stratum-2则从Stratum-1获取时间，

Stratum-3从Stratum-2获取时间，

以此类推，但Stratum层的总数限制在15以内。

所有这些服务器在逻辑上形成阶梯式的架构相互连接，而Stratum-1的时间服务器是整个系统的基础，

## 1、C/S合一

ntpd对下层client来说是service server，

对于上层server来说它是client，

也就是说新版的NTP服务程序已经不对服务端和客户端进行区分了，统一叫做ntpd。

ntpd根据配置文件的参数决定是要为其他服务器提供时钟服务或者是从其他服务器同步时钟。

所有的配置都在/etc/ntp.conf文件中。

## 2、NTP客户端同步间隔

NTP服务会间隔多长时间想时钟服务器请求一次时钟同步呢？

默认最小时间间隔为64s，

默认最大时间间隔是1024s（17分钟左右）。

64s是比较合理的，

默认间隔也是可调的

## 3、容忍误差范围

NTP服务并不是在任何情况下都会进行同步的。

当时钟服务器时间和本地时间相差大于1000s时，

NTP服务就会认为是人为调整了时钟或出现了硬件故障，

例如CMOS电池损坏等。

此时，NTP服务就会退出，需要人工（ntpdate …）进行时钟同步。

采用-g选项可以让ntpd忽略1000s或更大误差，设置时钟到server system time, 但是ntpd还是会因此退出。

## 4、层次（strata）

stratum根据上层server的层次而设定（+1）。

对于提供network time service provider的主机来说，stratum的设定要尽可能准确。

而作为局域网的time service provider，通常将stratum设置为10 （Stratum 10 is conventional for unsynchronized local clocks; it is high enough that nobody is likely to mistake it for a desirable clock to synchronize with.），如下：

server  127.127.1.0     # local clock

fudge   127.127.1.0     stratum 10

#stratum设置为其它值也是可以的，其范围为0~15

https://blog.csdn.net/weixin_45057618/article/details/120200341

# 参考资料

1、Linux的NTP配置总结

https://blog.csdn.net/xuleisdjn/article/details/78459835