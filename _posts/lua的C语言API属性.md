---
title: lua的C语言API属性
date: 2022-12-18 11:15:51
tags:
	- lua

---

--

作为一门嵌入式语言，Lua提供了丰富的CAPI与宿主进行通信。

了解更多的CAPI特性能帮助我们更好的发挥Lua虚拟机丰富的功能。



# C模块注入到lua的两种方式

1、C语言在创建lua_State后，给global table注入function，然后在lua里直接调用对应的函数。这个简单。但是一般不这么做。除了在简单测试的时候。

2、把C语言的函数封装成模块，lua通过require的方式来适应。这种比较实用。



# 关于EXTRA_STACK和LUA_MINSTACK

EXTRA_STACK是vm调用元方法预留的栈空间。

一般是5个slot。

而对于LUA_MINSTACK，每次lua去调用C函数的时候，会给C函数提供至少LUA_MINSTACK的栈空间大小。

一般是20个slot。

多层C函数嵌套会累加实用。所以需要留意。

# 编写C模块需要考虑的问题

## 设计层面

### 形式一

对象的内存由lua去创建。以userdata的形式存在。

lua来负责管理对象的内存和生命周期。

api以元表的形式注入。

通过`__gc`元方法来管理生命周期。

### 形式二

对象的内存在C语言里创建。

对象指针以lightuserdata的形式存在。

所有api平坦地注入lua。（跟元表方式相对立）

lua不管对象的生命周期。

### 形式三

相当于形式一和形式二混合。

对象内存是C里面创建。

但是对象指针放到userdata里。

api通过元表的方式进行注入。

通过`__gc`元方法来管理生命周期。

### 注意

使用userdata的，必须先创建userdata并设置好`__gc`，然后才能创建对象。

因为创建userdata可能失败，导致内存泄漏。

## 代码实现层面

1、考虑参数检查。

2、考虑错误处理。

3、应该使用lua_call，而不是lua_pcall，把错误抛出来，而不是吞掉。

4、跟lua进行复杂交互的时候，要考虑栈的slot够不够。尤其是在递归的时候。

# C模块异步回调lua

lua只支持单线程。

异步回调要保证同一个时间节点只有一个线程在操作lua。

可以加锁来保证。

也可以保证所有的回调函数都是在lua所在的线程来回调。



异步回调，必须使用lua_pcall。

这样来保证异步回调可以正常返回。

（因为异步回调被抛异常了，可能导致库函数堆栈异常）





# 参考资料

1、

https://www.zhyingkun.com/markdown/luacapi/