---
title: 《奔跑吧Linux内核》读书笔记
date: 2020-01-17 15:02:19
tags:
	- Linux
---

1

# 2 内存管理
从malloc说起。
	首先就是虚拟内存的概念。
	要理解虚拟内存，就需要了解mmu。
	要了解mmu，就需要了解linux是如何建立页表映射。
	页表映射包括：用户控件页表的建立、内核空间页表的建立。
	linux是如何查询页表和修改页表。
	物理内存，涉及到3个结构体：
		struct pg_data_t
		struct zone
		struct page
	这3个数据结构，描述了系统中物理内存的组织架构。
	有了物理内存，怎么跟虚拟内存建立映射关系呢？
	采用页表的方式。
	描述进程的虚拟内存用struct vm_area_struct 。
	为什么和进程地址空间建立映射的页面，有的叫匿名页面。有的叫page cache呢？
	物理内存和虚拟内存建立映射关系后，是以页为基础的。
	有时候内核需要几个字节的内存，这种分配给一个page太浪费了，所以有了slab机制。
	物理内存和虚拟内存的映射关系经常是建立之后又解除的。
	时间长了，物理页面布局就变得很混乱了。这个叫碎片化。
	这个时候，如果要分配大块的连续内存就很困难。所以需要进行内存规整。
	
## 2.1 物理内存初始化

### 2.1.1 内存管理概述
内存管理是一个很复杂的系统，涉及的内容很多。
如果用分层来描述，分为三层：
	用户空间层
	内核空间层
	硬件层
用户空间层，就是把brk和mmap系统调用进行封装。得到malloc、mmap这些C库函数。

### 2.1.2 内存大小
从dts里读取出来，添加到memblock子系统里。

### 2.1.3 物理内存映射
在映射页表之前，需要把页表的内存清零。

### 2.1.4 zone初始化

### 2.1.5 空间划分

### 2.1.6 物理内存初始化

## 2.2 页表的映射过程

### 2.2.1 arm32页表映射
在32bit的Linux内核里，使用了三层的映射模型。
pgd、pmd、pte。
但是arm32硬件只有两层。
所以代码里就需要合并2个层。
pmd被去掉了。

### 2.2.2 arm64页表映射
armv8-a的地址线只用了48根，而不是64根。因为够用了。
这样支持的物理地址空间已经可以到256TB了。

## 2.3 内核内存的布局图

